
> backend@2.0.0 test
> cross-env NODE_OPTIONS=--experimental-vm-modules jest --runInBand --passWithNoTests --verbose

  console.log
    [dotenv@17.2.3] injecting env (12) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    ΓÜá∩╕Å  Sentry not configured (SENTRY_DSN not set)

      at initSentry (config/sentry.js:13:17)

npm : (node:19080) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
At line:1 char:13
+ cd backend; npm test -- --verbose 2>&1 | Out-File -FilePath "test_res ...
+             ~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: ((node:19080) Ex...nge at any time:String) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError
 
(Use `node --trace-warnings ...` to show where the warning was created)
(node:19080) [MONGOOSE] Warning: Duplicate schema index on {"subdomain":1} found. This is often due to declaring an 
index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:19080) [MONGOOSE] Warning: Duplicate schema index on {"entryNumber":1} found. This is often due to declaring an 
index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:19080) [MONGOOSE] Warning: Duplicate schema index on {"code":1} found. This is often due to declaring an index 
using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:19080) [MONGODB DRIVER] Warning: useNewUrlParser is a deprecated option: useNewUrlParser has no effect since 
Node.js Driver version 4.0.0 and will be removed in the next major version
(node:19080) [MONGODB DRIVER] Warning: useUnifiedTopology is a deprecated option: useUnifiedTopology has no effect 
since Node.js Driver version 4.0.0 and will be removed in the next major version
2026-02-01 21:24:39 [[32minfo[39m]: ≡ƒì¬ Set deviceId cookie {"service":"bizzai-backend","deviceId":"057797bb...","sameSite":"strict","secure":false}
  console.log
    Γ£à Login successful - rate limit counters reset {
      ip: '::ffff:127.0.0.1',
      accountHash: '973dfe463ec85785',
      correlationId: 'unknown'
    }

      at handleLoginAttempt (middlewares/rateLimiter.js:332:17)

::ffff:127.0.0.1 - - [01/Feb/2026:15:54:39 +0000] "POST /api/auth/login HTTP/1.1" 200 573 "-" "-"
2026-02-01 21:24:39 [[32minfo[39m]: Stock movement logged: PURCHASE | Item: Test Item | Qty: 50 | Source: Purchase:697f773fc6363d9f2a9179b0 {"service":"bizzai-backend"}
2026-02-01 21:24:39 [[32minfo[39m]: Purchase created by Test User: PUR-00001 {"service":"bizzai-backend"}
2026-02-01 21:24:39 [[32minfo[39m]: Bill BILL-20260201-001 auto-created from Purchase PUR-00001 {"service":"bizzai-backend"}
2026-02-01 21:24:39 [[32minfo[39m]: Bill BILL-20260201-001 auto-created from Purchase PUR-00001 {"service":"bizzai-backend"}
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:39 +0000] "POST /api/purchases HTTP/1.1" 201 - "-" "-"
2026-02-01 21:24:40 [[32minfo[39m]: ≡ƒì¬ Set deviceId cookie {"service":"bizzai-backend","deviceId":"27df7e36...","sameSite":"strict","secure":false}
  console.log
    Γ£à Login successful - rate limit counters reset {
      ip: '::ffff:127.0.0.1',
      accountHash: '973dfe463ec85785',
      correlationId: 'unknown'
    }

      at handleLoginAttempt (middlewares/rateLimiter.js:332:17)

::ffff:127.0.0.1 - - [01/Feb/2026:15:54:40 +0000] "POST /api/auth/login HTTP/1.1" 200 573 "-" "-"
2026-02-01 21:24:40 [[32minfo[39m]: Stock movement logged: PURCHASE | Item: Test Item | Qty: 20 | Source: Purchase:697f7740c6363d9f2a917a50 {"service":"bizzai-backend"}
2026-02-01 21:24:40 [[32minfo[39m]: Stock movement logged: PURCHASE | Item: Item 2 | Qty: 30 | Source: Purchase:697f7740c6363d9f2a917a50 {"service":"bizzai-backend"}
2026-02-01 21:24:40 [[32minfo[39m]: Purchase created by Test User: PUR-00001 {"service":"bizzai-backend"}
2026-02-01 21:24:40 [[32minfo[39m]: Bill BILL-20260201-001 auto-created from Purchase PUR-00001 {"service":"bizzai-backend"}
2026-02-01 21:24:40 [[32minfo[39m]: Bill BILL-20260201-001 auto-created from Purchase PUR-00001 {"service":"bizzai-backend"}
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:40 +0000] "POST /api/purchases HTTP/1.1" 201 - "-" "-"
2026-02-01 21:24:40 [[32minfo[39m]: ≡ƒì¬ Set deviceId cookie {"service":"bizzai-backend","deviceId":"391a1756...","sameSite":"strict","secure":false}
  console.log
    Γ£à Login successful - rate limit counters reset {
      ip: '::ffff:127.0.0.1',
      accountHash: '973dfe463ec85785',
      correlationId: 'unknown'
    }

      at handleLoginAttempt (middlewares/rateLimiter.js:332:17)

::ffff:127.0.0.1 - - [01/Feb/2026:15:54:40 +0000] "POST /api/auth/login HTTP/1.1" 200 573 "-" "-"
2026-02-01 21:24:40 [[32minfo[39m]: Stock movement logged: PURCHASE | Item: Test Item | Qty: 10 | Source: Purchase:697f7740c6363d9f2a917ac1 {"service":"bizzai-backend"}
2026-02-01 21:24:40 [[32minfo[39m]: Purchase created by Test User: PUR-00001 {"service":"bizzai-backend"}
2026-02-01 21:24:40 [[32minfo[39m]: Bill BILL-20260201-001 auto-created from Purchase PUR-00001 {"service":"bizzai-backend"}
2026-02-01 21:24:40 [[32minfo[39m]: Bill BILL-20260201-001 auto-created from Purchase PUR-00001 {"service":"bizzai-backend"}
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:40 +0000] "POST /api/purchases HTTP/1.1" 201 - "-" "-"
2026-02-01 21:24:40 [[32minfo[39m]: ≡ƒì¬ Set deviceId cookie {"service":"bizzai-backend","deviceId":"f53c7695...","sameSite":"strict","secure":false}
  console.log
    Γ£à Login successful - rate limit counters reset {
      ip: '::ffff:127.0.0.1',
      accountHash: '973dfe463ec85785',
      correlationId: 'unknown'
    }

      at handleLoginAttempt (middlewares/rateLimiter.js:332:17)

::ffff:127.0.0.1 - - [01/Feb/2026:15:54:40 +0000] "POST /api/auth/login HTTP/1.1" 200 573 "-" "-"
2026-02-01 21:24:41 [[32minfo[39m]: Stock movement logged: PURCHASE | Item: Test Item | Qty: 10 | Source: Purchase:697f7741c6363d9f2a917b17 {"service":"bizzai-backend"}
2026-02-01 21:24:41 [[32minfo[39m]: Purchase created by Test User: PUR-00001 {"service":"bizzai-backend"}
2026-02-01 21:24:41 [[32minfo[39m]: Bill BILL-20260201-001 auto-created from Purchase PUR-00001 {"service":"bizzai-backend"}
2026-02-01 21:24:41 [[32minfo[39m]: Bill BILL-20260201-001 auto-created from Purchase PUR-00001 {"service":"bizzai-backend"}
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:41 +0000] "POST /api/purchases HTTP/1.1" 201 - "-" "-"
2026-02-01 21:24:41 [[32minfo[39m]: ≡ƒì¬ Set deviceId cookie {"service":"bizzai-backend","deviceId":"14a78f8e...","sameSite":"strict","secure":false}
  console.log
    Γ£à Login successful - rate limit counters reset {
      ip: '::ffff:127.0.0.1',
      accountHash: '973dfe463ec85785',
      correlationId: 'unknown'
    }

      at handleLoginAttempt (middlewares/rateLimiter.js:332:17)

::ffff:127.0.0.1 - - [01/Feb/2026:15:54:41 +0000] "POST /api/auth/login HTTP/1.1" 200 573 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:41 +0000] "POST /api/purchases HTTP/1.1" 404 70 "-" "-"
2026-02-01 21:24:41 [[32minfo[39m]: ≡ƒì¬ Set deviceId cookie {"service":"bizzai-backend","deviceId":"3029c5c5...","sameSite":"strict","secure":false}
  console.log
    Γ£à Login successful - rate limit counters reset {
      ip: '::ffff:127.0.0.1',
      accountHash: '973dfe463ec85785',
      correlationId: 'unknown'
    }

      at handleLoginAttempt (middlewares/rateLimiter.js:332:17)

::ffff:127.0.0.1 - - [01/Feb/2026:15:54:41 +0000] "POST /api/auth/login HTTP/1.1" 200 573 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:41 +0000] "GET /api/purchases HTTP/1.1" 200 - "-" "-"
2026-02-01 21:24:41 [[32minfo[39m]: ≡ƒì¬ Set deviceId cookie {"service":"bizzai-backend","deviceId":"ddb37d80...","sameSite":"strict","secure":false}
  console.log
    Γ£à Login successful - rate limit counters reset {
      ip: '::ffff:127.0.0.1',
      accountHash: '973dfe463ec85785',
      correlationId: 'unknown'
    }

      at handleLoginAttempt (middlewares/rateLimiter.js:332:17)

::ffff:127.0.0.1 - - [01/Feb/2026:15:54:41 +0000] "POST /api/auth/login HTTP/1.1" 200 573 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:41 +0000] "GET /api/purchases?supplier=697f7741c6363d9f2a917be4 HTTP/1.1" 200 - "-" "-"
2026-02-01 21:24:42 [[32minfo[39m]: ≡ƒì¬ Set deviceId cookie {"service":"bizzai-backend","deviceId":"0cb6d37f...","sameSite":"strict","secure":false}
  console.log
    Γ£à Login successful - rate limit counters reset {
      ip: '::ffff:127.0.0.1',
      accountHash: '973dfe463ec85785',
      correlationId: 'unknown'
    }

      at handleLoginAttempt (middlewares/rateLimiter.js:332:17)

::ffff:127.0.0.1 - - [01/Feb/2026:15:54:42 +0000] "POST /api/auth/login HTTP/1.1" 200 573 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:42 +0000] "GET /api/purchases HTTP/1.1" 200 - "-" "-"
2026-02-01 21:24:42 [[32minfo[39m]: ≡ƒì¬ Set deviceId cookie {"service":"bizzai-backend","deviceId":"50311b0f...","sameSite":"strict","secure":false}
  console.log
    Γ£à Login successful - rate limit counters reset {
      ip: '::ffff:127.0.0.1',
      accountHash: '973dfe463ec85785',
      correlationId: 'unknown'
    }

      at handleLoginAttempt (middlewares/rateLimiter.js:332:17)

::ffff:127.0.0.1 - - [01/Feb/2026:15:54:42 +0000] "POST /api/auth/login HTTP/1.1" 200 573 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:42 +0000] "PUT /api/purchases/697f7742c6363d9f2a917c83/cancel HTTP/1.1" 404 184 "-" "-"
FAIL tests/integration/purchase.test.js (10.974 s)
  Purchase API Integration Tests
    POST /api/purchases
      ├ù should create purchase and update stock (1607 ms)
      ΓêÜ should handle multiple items in purchase (632 ms)
      ΓêÜ should apply bill discount correctly (356 ms)
      ΓêÜ should handle credit purchase (318 ms)
      ├ù should fail with invalid item (300 ms)
    GET /api/purchases
      ΓêÜ should get all purchases for authenticated user (311 ms)
      ΓêÜ should filter purchases by supplier (283 ms)
      ΓêÜ should not return other users' purchases (397 ms)
    PUT /api/purchases/:id/cancel
      ├ù should cancel purchase and revert stock (281 ms)

  ΓùÅ Purchase API Integration Tests ΓÇ║ POST /api/purchases ΓÇ║ should create purchase and update stock

    expect(received).toBe(expected) // Object.is equality

    Expected: 405
    Received: 0

    [0m [90m 85 |[39m             [90m// Verify purchase calculations[39m
     [90m 86 |[39m             
expect(response[33m.[39mbody[33m.[39mpurchase[33m.[39msubtotal)[33m.[39mtoBe([35m4500[39m)[33m;[39m 
[90m// 50 * 90[39m
    [31m[1m>[22m[39m[90m 87 |[39m             
expect(response[33m.[39mbody[33m.[39mpurchase[33m.[39mtotalCGST)[33m.[39mtoBe([35m405[39m)[33m;[39m 
[90m// 9% of 4500[39m
     [90m    |[39m                                                      [31m[1m^[22m[39m
     [90m 88 |[39m             
expect(response[33m.[39mbody[33m.[39mpurchase[33m.[39mtotalSGST)[33m.[39mtoBe([35m405[39m)[33m;[39m 
[90m// 9% of 4500[39m
     [90m 89 |[39m             
expect(response[33m.[39mbody[33m.[39mpurchase[33m.[39mtotalAmount)[33m.[39mtoBe([35m5310[39m)[33m;[39m 
[90m// 4500 + 810[39m
     [90m 90 |[39m         })[33m;[39m[0m

      at Object.<anonymous> (tests/integration/purchase.test.js:87:54)

  ΓùÅ Purchase API Integration Tests ΓÇ║ POST /api/purchases ΓÇ║ should fail with invalid item

    expected 400 "Bad Request", got 404 "Not Found"

    [0m [90m 217 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer 
${authToken}`[39m)
     [90m 218 |[39m                 [33m.[39msend(purchaseData)
    [31m[1m>[22m[39m[90m 219 |[39m                 [33m.[39mexpect([35m400[39m)[33m;[39m
     [90m     |[39m                  [31m[1m^[22m[39m
     [90m 220 |[39m
     [90m 221 |[39m             
expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 222 |[39m         })[33m;[39m[0m

      at Object.<anonymous> (tests/integration/purchase.test.js:219:18)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ΓùÅ Purchase API Integration Tests ΓÇ║ PUT /api/purchases/:id/cancel ΓÇ║ should cancel purchase and revert stock

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 345 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer 
${authToken}`[39m)
     [90m 346 |[39m                 [33m.[39msend({ cancelReason[33m:[39m [32m'Supplier cancelled order'[39m })
    [31m[1m>[22m[39m[90m 347 |[39m                 [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m                  [31m[1m^[22m[39m
     [90m 348 |[39m
     [90m 349 |[39m             
expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 350 |[39m             expect(response[33m.[39mbody[33m.[39mpurchase[33m.[39mstatus)[33m.[39mtoBe([
32m'cancelled'[39m)[33m;[39m[0m

      at Object.<anonymous> (tests/integration/purchase.test.js:347:18)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  console.log
    [dotenv@17.2.3] injecting env (12) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    ΓÜá∩╕Å  Sentry not configured (SENTRY_DSN not set)

      at initSentry (config/sentry.js:13:17)

(node:19080) [MONGOOSE] Warning: Duplicate schema index on {"subdomain":1} found. This is often due to declaring an 
index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:19080) [MONGOOSE] Warning: Duplicate schema index on {"entryNumber":1} found. This is often due to declaring an 
index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:19080) [MONGOOSE] Warning: Duplicate schema index on {"code":1} found. This is often due to declaring an index 
using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:19080) [MONGODB DRIVER] Warning: useNewUrlParser is a deprecated option: useNewUrlParser has no effect since 
Node.js Driver version 4.0.0 and will be removed in the next major version
(node:19080) [MONGODB DRIVER] Warning: useUnifiedTopology is a deprecated option: useUnifiedTopology has no effect 
since Node.js Driver version 4.0.0 and will be removed in the next major version
2026-02-01 21:24:48 [[32minfo[39m]: ≡ƒì¬ Set deviceId cookie {"service":"bizzai-backend","deviceId":"f4e76061...","sameSite":"strict","secure":false}
  console.log
    Γ£à Login successful - rate limit counters reset {
      ip: '::ffff:127.0.0.1',
      accountHash: '238f99de3114657e',
      correlationId: 'unknown'
    }

      at handleLoginAttempt (middlewares/rateLimiter.js:332:17)

::ffff:127.0.0.1 - - [01/Feb/2026:15:54:48 +0000] "POST /api/auth/login HTTP/1.1" 200 519 "-" "-"
2026-02-01 21:24:48 [[32minfo[39m]: ≡ƒì¬ Set deviceId cookie {"service":"bizzai-backend","deviceId":"850fd94d...","sameSite":"strict","secure":false}
  console.log
    Γ£à Login successful - rate limit counters reset {
      ip: '::ffff:127.0.0.1',
      accountHash: '82b0bc9b60e6d1bd',
      correlationId: 'unknown'
    }

      at handleLoginAttempt (middlewares/rateLimiter.js:332:17)

::ffff:127.0.0.1 - - [01/Feb/2026:15:54:48 +0000] "POST /api/auth/login HTTP/1.1" 200 519 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:48 +0000] "GET /api/inventory HTTP/1.1" 200 550 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:48 +0000] "GET /api/inventory HTTP/1.1" 401 28 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:48 +0000] "GET /api/inventory/697f7748b8e93febc52f315c HTTP/1.1" 401 28 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:48 +0000] "PUT /api/inventory/697f7748b8e93febc52f315a HTTP/1.1" 401 28 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:48 +0000] "DELETE /api/inventory/697f7748b8e93febc52f315c HTTP/1.1" 401 28 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:49 +0000] "GET /api/reports/dashboard HTTP/1.1" 404 160 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:49 +0000] "GET /api/reports/dashboard HTTP/1.1" 404 160 "-" "-"
FAIL tests/integration/multiTenancy.test.js (5.63 s)
  Multi-Tenancy Integration Tests
    Tenant Isolation - Items
      ΓêÜ user1 should only see org1 items (174 ms)
      ├ù user2 should only see org2 items (117 ms)
      ├ù user1 cannot access org2 item by ID (114 ms)
      ├ù user2 cannot update org1 item (76 ms)
      ├ù user1 cannot delete org2 item (123 ms)
    Tenant Isolation - Invoices
      ├ù user1 should only see org1 invoices (38 ms)
      ├ù user2 should only see org2 invoices (22 ms)
    Tenant Isolation - Purchases
      ├ù user1 should only see org1 purchases (23 ms)
      ├ù user2 should only see org2 purchases (25 ms)
    Cross-Tenant Prevention
      ├ù should prevent cross-tenant data leakage in aggregations (36 ms)
      ΓêÜ should enforce organizationId in all queries (37 ms)

  ΓùÅ Multi-Tenancy Integration Tests ΓÇ║ Tenant Isolation - Items ΓÇ║ user2 should only see org2 items

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 118 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer 
${user2Token}`[39m)[33m;[39m
     [90m 119 |[39m
    [31m[1m>[22m[39m[90m 120 |[39m             
expect(res[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 121 |[39m             [36mconst[39m items [33m=[39m res[33m.[39mbody[33m.[39mitems [33m||[39m 
res[33m.[39mbody[33m;[39m
     [90m 122 |[39m             expect(items[33m.[39msome(i [33m=>[39m i[33m.[39m_id[33m.[39mtoString() 
[33m===[39m item2[33m.[39m_id[33m.[39mtoString()))[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 123 |[39m             expect(items[33m.[39msome(i [33m=>[39m i[33m.[39m_id[33m.[39mtoString() 
[33m===[39m item1[33m.[39m_id[33m.[39mtoString()))[33m.[39mtoBe([36mfalse[39m)[33m;[39m[0m

      at Object.<anonymous> (tests/integration/multiTenancy.test.js:120:32)

  ΓùÅ Multi-Tenancy Integration Tests ΓÇ║ Tenant Isolation - Items ΓÇ║ user1 cannot access org2 item by ID

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 401

    [0m [90m 129 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer 
${user1Token}`[39m)[33m;[39m
     [90m 130 |[39m
    [31m[1m>[22m[39m[90m 131 |[39m             
expect(res[33m.[39mstatus)[33m.[39mtoBe([35m404[39m)[33m;[39m
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 132 |[39m         })[33m;[39m
     [90m 133 |[39m
     [90m 134 |[39m         test([32m'user2 cannot update org1 item'[39m[33m,[39m [36masync[39m () 
[33m=>[39m {[0m

      at Object.<anonymous> (tests/integration/multiTenancy.test.js:131:32)

  ΓùÅ Multi-Tenancy Integration Tests ΓÇ║ Tenant Isolation - Items ΓÇ║ user2 cannot update org1 item

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 401

    [0m [90m 138 |[39m                 [33m.[39msend({ currentStock[33m:[39m [35m999[39m })[33m;[39m
     [90m 139 |[39m
    [31m[1m>[22m[39m[90m 140 |[39m             
expect(res[33m.[39mstatus)[33m.[39mtoBe([35m404[39m)[33m;[39m
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 141 |[39m
     [90m 142 |[39m             [90m// Verify item not modified[39m
     [90m 143 |[39m             [36mconst[39m item [33m=[39m [36mawait[39m 
[33mItem[39m[33m.[39mfindById(item1[33m.[39m_id)[33m;[39m[0m

      at Object.<anonymous> (tests/integration/multiTenancy.test.js:140:32)

  ΓùÅ Multi-Tenancy Integration Tests ΓÇ║ Tenant Isolation - Items ΓÇ║ user1 cannot delete org2 item

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 401

    [0m [90m 150 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer 
${user1Token}`[39m)[33m;[39m
     [90m 151 |[39m
    [31m[1m>[22m[39m[90m 152 |[39m             
expect(res[33m.[39mstatus)[33m.[39mtoBe([35m404[39m)[33m;[39m
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 153 |[39m
     [90m 154 |[39m             [90m// Verify item still exists[39m
     [90m 155 |[39m             [36mconst[39m item [33m=[39m [36mawait[39m 
[33mItem[39m[33m.[39mfindById(item2[33m.[39m_id)[33m;[39m[0m

      at Object.<anonymous> (tests/integration/multiTenancy.test.js:152:32)

  ΓùÅ Multi-Tenancy Integration Tests ΓÇ║ Tenant Isolation - Invoices ΓÇ║ user1 should only see org1 invoices

    ValidationError: Invoice validation failed: subtotal: Path `subtotal` is required., items.0.total: Path `total` is 
required., items.0.price: Path `price` is required., items.0.item: Path `item` is required.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3373:32)
      at node_modules/mongoose/lib/document.js:3134:17
      at node_modules/mongoose/lib/schemaType.js:1446:9

  ΓùÅ Multi-Tenancy Integration Tests ΓÇ║ Tenant Isolation - Invoices ΓÇ║ user2 should only see org2 invoices

    ValidationError: Invoice validation failed: subtotal: Path `subtotal` is required., items.0.total: Path `total` is 
required., items.0.price: Path `price` is required., items.0.item: Path `item` is required.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3373:32)
      at node_modules/mongoose/lib/document.js:3134:17
      at node_modules/mongoose/lib/schemaType.js:1446:9

  ΓùÅ Multi-Tenancy Integration Tests ΓÇ║ Tenant Isolation - Purchases ΓÇ║ user1 should only see org1 purchases

    ValidationError: Purchase validation failed: supplier: Path `supplier` is required., supplierInvoiceDate: Path 
`supplierInvoiceDate` is required., supplierInvoiceNo: Path `supplierInvoiceNo` is required., items.0.total: Path 
`total` is required., items.0.taxableValue: Path `taxableValue` is required., items.0.purchaseRate: Path 
`purchaseRate` is required., items.0.item: Path `item` is required.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3373:32)
      at node_modules/mongoose/lib/document.js:3134:17
      at node_modules/mongoose/lib/schemaType.js:1446:9

  ΓùÅ Multi-Tenancy Integration Tests ΓÇ║ Tenant Isolation - Purchases ΓÇ║ user2 should only see org2 purchases

    ValidationError: Purchase validation failed: supplier: Path `supplier` is required., supplierInvoiceDate: Path 
`supplierInvoiceDate` is required., supplierInvoiceNo: Path `supplierInvoiceNo` is required., items.0.total: Path 
`total` is required., items.0.taxableValue: Path `taxableValue` is required., items.0.purchaseRate: Path 
`purchaseRate` is required., items.0.item: Path `item` is required.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3373:32)
      at node_modules/mongoose/lib/document.js:3134:17
      at node_modules/mongoose/lib/schemaType.js:1446:9

  ΓùÅ Multi-Tenancy Integration Tests ΓÇ║ Cross-Tenant Prevention ΓÇ║ should prevent cross-tenant data leakage in 
aggregations

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

    [0m [90m 266 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer 
${user2Token}`[39m)[33m;[39m
     [90m 267 |[39m
    [31m[1m>[22m[39m[90m 268 |[39m             
expect(res1[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                 [31m[1m^[22m[39m
     [90m 269 |[39m             expect(res2[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m 270 |[39m
     [90m 271 |[39m             [90m// Dashboards should have different data[39m[0m

      at Object.<anonymous> (tests/integration/multiTenancy.test.js:268:33)

  console.log
    [dotenv@17.2.3] injecting env (12) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    ΓÜá∩╕Å  Sentry not configured (SENTRY_DSN not set)

      at initSentry (config/sentry.js:13:17)

(node:19080) [MONGOOSE] Warning: Duplicate schema index on {"subdomain":1} found. This is often due to declaring an 
index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:19080) [MONGOOSE] Warning: Duplicate schema index on {"entryNumber":1} found. This is often due to declaring an 
index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:19080) [MONGOOSE] Warning: Duplicate schema index on {"code":1} found. This is often due to declaring an index 
using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:19080) [MONGODB DRIVER] Warning: useNewUrlParser is a deprecated option: useNewUrlParser has no effect since 
Node.js Driver version 4.0.0 and will be removed in the next major version
(node:19080) [MONGODB DRIVER] Warning: useUnifiedTopology is a deprecated option: useUnifiedTopology has no effect 
since Node.js Driver version 4.0.0 and will be removed in the next major version
2026-02-01 21:24:53 [[32minfo[39m]: ≡ƒì¬ Set deviceId cookie {"service":"bizzai-backend","deviceId":"0b3576c0...","sameSite":"strict","secure":false}
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:53 +0000] "POST /api/auth/register HTTP/1.1" 201 512 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:53 +0000] "POST /api/auth/register HTTP/1.1" 400 61 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:54 +0000] "POST /api/auth/register HTTP/1.1" 400 61 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:54 +0000] "POST /api/auth/register HTTP/1.1" 400 61 "-" "-"
2026-02-01 21:24:54 [[32minfo[39m]: ≡ƒì¬ Set deviceId cookie {"service":"bizzai-backend","deviceId":"0733fbbb...","sameSite":"strict","secure":false}
  console.log
    Γ£à Login successful - rate limit counters reset {
      ip: '::ffff:127.0.0.1',
      accountHash: '9f514e36d9d61641',
      correlationId: 'unknown'
    }

      at handleLoginAttempt (middlewares/rateLimiter.js:332:17)

::ffff:127.0.0.1 - - [01/Feb/2026:15:54:54 +0000] "POST /api/auth/login HTTP/1.1" 200 574 "-" "-"
2026-02-01 21:24:55 [[33mwarn[39m]: SECURITY: Login attempt failed {"service":"bizzai-backend","ip":"::ffff:127.0.0.1","accountHash":"9f514e36d9d61641","correlationId":"unknown"}
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:55 +0000] "POST /api/auth/login HTTP/1.1" 401 49 "-" "-"
2026-02-01 21:24:55 [[33mwarn[39m]: SECURITY: Login attempt failed {"service":"bizzai-backend","ip":"::ffff:127.0.0.1","accountHash":"04e8703fcfb60849","correlationId":"unknown"}
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:55 +0000] "POST /api/auth/login HTTP/1.1" 404 44 "-" "-"
2026-02-01 21:24:55 [[33mwarn[39m]: SECURITY: Login attempt failed {"service":"bizzai-backend","ip":"::ffff:127.0.0.1","accountHash":"9f514e36d9d61641","correlationId":"unknown"}
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:55 +0000] "POST /api/auth/login HTTP/1.1" 401 49 "-" "-"
2026-02-01 21:24:56 [[33mwarn[39m]: SECURITY: Login attempt failed {"service":"bizzai-backend","ip":"::ffff:127.0.0.1","accountHash":"9f514e36d9d61641","correlationId":"unknown"}
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:56 +0000] "POST /api/auth/login HTTP/1.1" 401 49 "-" "-"
2026-02-01 21:24:56 [[33mwarn[39m]: SECURITY: Login attempt failed {"service":"bizzai-backend","ip":"::ffff:127.0.0.1","accountHash":"9f514e36d9d61641","correlationId":"unknown"}
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:56 +0000] "POST /api/auth/login HTTP/1.1" 401 49 "-" "-"
2026-02-01 21:24:56 [[33mwarn[39m]: SECURITY: IP rate limit exceeded {"service":"bizzai-backend","ip":"::ffff:127.0.0.1","count":5,"correlationId":"unknown"}
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:56 +0000] "POST /api/auth/login HTTP/1.1" 429 92 "-" "-"
2026-02-01 21:24:56 [[33mwarn[39m]: SECURITY: IP rate limit exceeded {"service":"bizzai-backend","ip":"::ffff:127.0.0.1","count":5,"correlationId":"unknown"}
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:56 +0000] "POST /api/auth/login HTTP/1.1" 429 92 "-" "-"
2026-02-01 21:24:56 [[33mwarn[39m]: SECURITY: IP rate limit exceeded {"service":"bizzai-backend","ip":"::ffff:127.0.0.1","count":5,"correlationId":"unknown"}
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:56 +0000] "POST /api/auth/login HTTP/1.1" 429 92 "-" "-"
2026-02-01 21:24:56 [[33mwarn[39m]: SECURITY: IP rate limit exceeded {"service":"bizzai-backend","ip":"::ffff:127.0.0.1","count":5,"correlationId":"unknown"}
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:56 +0000] "POST /api/auth/login HTTP/1.1" 429 92 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:56 +0000] "GET /api/auth/me HTTP/1.1" 404 150 "-" "-"
2026-02-01 21:24:56 [[33mwarn[39m]: SECURITY: IP rate limit exceeded {"service":"bizzai-backend","ip":"::ffff:127.0.0.1","count":5,"correlationId":"unknown"}
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:56 +0000] "POST /api/auth/login HTTP/1.1" 429 92 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:56 +0000] "GET /api/auth/me HTTP/1.1" 404 150 "-" "-"
2026-02-01 21:24:56 [[33mwarn[39m]: SECURITY: IP rate limit exceeded {"service":"bizzai-backend","ip":"::ffff:127.0.0.1","count":5,"correlationId":"unknown"}
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:56 +0000] "POST /api/auth/login HTTP/1.1" 429 92 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:56 +0000] "GET /api/auth/me HTTP/1.1" 404 150 "-" "-"
2026-02-01 21:24:56 [[33mwarn[39m]: SECURITY: IP rate limit exceeded {"service":"bizzai-backend","ip":"::ffff:127.0.0.1","count":5,"correlationId":"unknown"}
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:56 +0000] "POST /api/auth/login HTTP/1.1" 429 92 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:54:56 +0000] "POST /api/auth/logout HTTP/1.1" 404 155 "-" "-"
FAIL tests/integration/auth.test.js (8.006 s)
  Authentication API Integration Tests
    POST /api/auth/register
      ├ù should register a new user successfully (838 ms)
      ├ù should fail with duplicate email (293 ms)
      ΓêÜ should fail with weak password (230 ms)
      ΓêÜ should fail with missing required fields (55 ms)
    POST /api/auth/login
      ├ù should login successfully with correct credentials (542 ms)
      ΓêÜ should fail with incorrect password (671 ms)
      ├ù should fail with non-existent email (167 ms)
      ├ù should lock account after 5 failed attempts (519 ms)
    GET /api/auth/me
      ├ù should get current user with valid token (148 ms)
      ├ù should fail without token (149 ms)
      ├ù should fail with invalid token (146 ms)
    POST /api/auth/logout
      ├ù should logout successfully (140 ms)

  ΓùÅ Authentication API Integration Tests ΓÇ║ POST /api/auth/register ΓÇ║ should register a new user successfully

    expect(received).toHaveProperty(path, value)

    Matcher error: received value must not be null nor undefined

    Received has value: undefined

    [0m [90m 21 |[39m
     [90m 22 |[39m             
expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 23 |[39m             
expect(response[33m.[39mbody[33m.[39muser)[33m.[39mtoHaveProperty([32m'email'[39m[33m,[39m 
userData[33m.[39memail)[33m;[39m
     [90m    |[39m                                        [31m[1m^[22m[39m
     [90m 24 |[39m             
expect(response[33m.[39mbody[33m.[39muser)[33m.[39mtoHaveProperty([32m'name'[39m[33m,[39m 
userData[33m.[39mname)[33m;[39m
     [90m 25 |[39m             expect(response[33m.[39mbody)[33m.[39mtoHaveProperty([32m'token'[39m)[33m;[39m
     [90m 26 |[39m             expect(response[33m.[39mbody[33m.[39muser)[33m.[39mnot[33m.[39mtoHaveProperty(
[32m'password'[39m)[33m;[39m[0m

      at Object.<anonymous> (tests/integration/auth.test.js:23:40)

  ΓùÅ Authentication API Integration Tests ΓÇ║ POST /api/auth/register ΓÇ║ should fail with duplicate email

    expect(received).toContain(expected) // indexOf

    Expected substring: "already exists"
    Received string:    "Please fill all required fields"

    [0m [90m 48 |[39m
     [90m 49 |[39m             
expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 50 |[39m             
expect(response[33m.[39mbody[33m.[39mmessage)[33m.[39mtoContain([32m'already exists'[39m)[33m;[39m
     [90m    |[39m                                           [31m[1m^[22m[39m
     [90m 51 |[39m         })[33m;[39m
     [90m 52 |[39m
     [90m 53 |[39m         test([32m'should fail with weak password'[39m[33m,[39m [36masync[39m () 
[33m=>[39m {[0m

      at Object.<anonymous> (tests/integration/auth.test.js:50:43)

  ΓùÅ Authentication API Integration Tests ΓÇ║ POST /api/auth/login ΓÇ║ should login successfully with correct 
credentials

    expect(received).toHaveProperty(path, value)

    Matcher error: received value must not be null nor undefined

    Received has value: undefined

    [0m [90m 102 |[39m             
expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 103 |[39m             
expect(response[33m.[39mbody)[33m.[39mtoHaveProperty([32m'token'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 104 |[39m             
expect(response[33m.[39mbody[33m.[39muser)[33m.[39mtoHaveProperty([32m'email'[39m[33m,[39m 
[32m'login@example.com'[39m)[33m;[39m
     [90m     |[39m                                        [31m[1m^[22m[39m
     [90m 105 |[39m             
expect(response[33m.[39mbody[33m.[39muser)[33m.[39mnot[33m.[39mtoHaveProperty([32m'password'[39m)[33m;[39m
     [90m 106 |[39m
     [90m 107 |[39m             [90m// Verify login history updated[39m[0m

      at Object.<anonymous> (tests/integration/auth.test.js:104:40)

  ΓùÅ Authentication API Integration Tests ΓÇ║ POST /api/auth/login ΓÇ║ should fail with non-existent email

    expected 401 "Unauthorized", got 404 "Not Found"

    [0m [90m 131 |[39m                     password[33m:[39m [32m'Password123!'[39m
     [90m 132 |[39m                 })
    [31m[1m>[22m[39m[90m 133 |[39m                 [33m.[39mexpect([35m401[39m)[33m;[39m
     [90m     |[39m                  [31m[1m^[22m[39m
     [90m 134 |[39m
     [90m 135 |[39m             
expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 136 |[39m         })[33m;[39m[0m

      at Object.<anonymous> (tests/integration/auth.test.js:133:18)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ΓùÅ Authentication API Integration Tests ΓÇ║ POST /api/auth/login ΓÇ║ should lock account after 5 failed attempts

    expected 423 "Locked", got 429 "Too Many Requests"

    [0m [90m 154 |[39m                     password[33m:[39m [32m'Password123!'[39m
     [90m 155 |[39m                 })
    [31m[1m>[22m[39m[90m 156 |[39m                 [33m.[39mexpect([35m423[39m)[33m;[39m
     [90m     |[39m                  [31m[1m^[22m[39m
     [90m 157 |[39m
     [90m 158 |[39m             
expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 159 |[39m             
expect(response[33m.[39mbody[33m.[39mmessage)[33m.[39mtoContain([32m'locked'[39m)[33m;[39m[0m

      at Object.<anonymous> (tests/integration/auth.test.js:156:18)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ΓùÅ Authentication API Integration Tests ΓÇ║ GET /api/auth/me ΓÇ║ should get current user with valid token

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 187 |[39m                 [33m.[39m[36mget[39m([32m'/api/auth/me'[39m)
     [90m 188 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer 
${authToken}`[39m)
    [31m[1m>[22m[39m[90m 189 |[39m                 [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m                  [31m[1m^[22m[39m
     [90m 190 |[39m
     [90m 191 |[39m             
expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 192 |[39m             
expect(response[33m.[39mbody[33m.[39muser)[33m.[39mtoHaveProperty([32m'email'[39m[33m,[39m 
testUser[33m.[39memail)[33m;[39m[0m

      at Object.<anonymous> (tests/integration/auth.test.js:189:18)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ΓùÅ Authentication API Integration Tests ΓÇ║ GET /api/auth/me ΓÇ║ should fail without token

    expected 401 "Unauthorized", got 404 "Not Found"

    [0m [90m 197 |[39m             [36mconst[39m response [33m=[39m [36mawait[39m request(app)
     [90m 198 |[39m                 [33m.[39m[36mget[39m([32m'/api/auth/me'[39m)
    [31m[1m>[22m[39m[90m 199 |[39m                 [33m.[39mexpect([35m401[39m)[33m;[39m
     [90m     |[39m                  [31m[1m^[22m[39m
     [90m 200 |[39m
     [90m 201 |[39m             
expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 202 |[39m         })[33m;[39m[0m

      at Object.<anonymous> (tests/integration/auth.test.js:199:18)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ΓùÅ Authentication API Integration Tests ΓÇ║ GET /api/auth/me ΓÇ║ should fail with invalid token

    expected 401 "Unauthorized", got 404 "Not Found"

    [0m [90m 206 |[39m                 [33m.[39m[36mget[39m([32m'/api/auth/me'[39m)
     [90m 207 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m'Bearer 
invalid_token'[39m)
    [31m[1m>[22m[39m[90m 208 |[39m                 [33m.[39mexpect([35m401[39m)[33m;[39m
     [90m     |[39m                  [31m[1m^[22m[39m
     [90m 209 |[39m
     [90m 210 |[39m             
expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 211 |[39m         })[33m;[39m[0m

      at Object.<anonymous> (tests/integration/auth.test.js:208:18)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ΓùÅ Authentication API Integration Tests ΓÇ║ POST /api/auth/logout ΓÇ║ should logout successfully

    expected 200 "OK", got 404 "Not Found"

    [0m [90m 232 |[39m                 [33m.[39mpost([32m'/api/auth/logout'[39m)
     [90m 233 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer 
${authToken}`[39m)
    [31m[1m>[22m[39m[90m 234 |[39m                 [33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m                  [31m[1m^[22m[39m
     [90m 235 |[39m
     [90m 236 |[39m             
expect(response[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 237 |[39m             expect(response[33m.[39mbody[33m.[39mmessage)[33m.[39mtoContain([32m'Logged 
out'[39m)[33m;[39m[0m

      at Object.<anonymous> (tests/integration/auth.test.js:234:18)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  console.log
    [dotenv@17.2.3] injecting env (12) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    ΓÜá∩╕Å  Sentry not configured (SENTRY_DSN not set)

      at initSentry (config/sentry.js:13:17)

(node:19080) [MONGOOSE] Warning: Duplicate schema index on {"subdomain":1} found. This is often due to declaring an 
index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:19080) [MONGOOSE] Warning: Duplicate schema index on {"entryNumber":1} found. This is often due to declaring an 
index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:19080) [MONGOOSE] Warning: Duplicate schema index on {"code":1} found. This is often due to declaring an index 
using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:19080) [MONGODB DRIVER] Warning: useNewUrlParser is a deprecated option: useNewUrlParser has no effect since 
Node.js Driver version 4.0.0 and will be removed in the next major version
(node:19080) [MONGODB DRIVER] Warning: useUnifiedTopology is a deprecated option: useUnifiedTopology has no effect 
since Node.js Driver version 4.0.0 and will be removed in the next major version
2026-02-01 21:25:01 [[32minfo[39m]: ≡ƒì¬ Set deviceId cookie {"service":"bizzai-backend","deviceId":"8fac5c5e...","sameSite":"strict","secure":false}
  console.log
    Γ£à Login successful - rate limit counters reset {
      ip: '::ffff:127.0.0.1',
      accountHash: '03ec4a53d5b62fbb',
      correlationId: 'unknown'
    }

      at handleLoginAttempt (middlewares/rateLimiter.js:332:17)

::ffff:127.0.0.1 - - [01/Feb/2026:15:55:01 +0000] "POST /api/auth/login HTTP/1.1" 200 550 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:55:02 +0000] "GET /api/financial-periods HTTP/1.1" 403 105 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:55:02 +0000] "GET /api/financial-periods?status=open HTTP/1.1" 401 28 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:55:02 +0000] "POST /api/financial-periods HTTP/1.1" 401 28 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:55:02 +0000] "POST /api/financial-periods HTTP/1.1" 401 28 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:55:02 +0000] "POST /api/financial-periods/generate/2028 HTTP/1.1" 401 28 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:55:02 +0000] "PUT /api/financial-periods/697f775588aa67b087f5d025/lock HTTP/1.1" 401 28 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:55:02 +0000] "PUT /api/financial-periods/697f775588aa67b087f5d028/unlock HTTP/1.1" 401 28 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:55:02 +0000] "PUT /api/financial-periods/697f775688aa67b087f5d1a3/close HTTP/1.1" 401 28 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:55:02 +0000] "PUT /api/financial-periods/697f775588aa67b087f5d02b/unlock HTTP/1.1" 401 28 "-" "-"
FAIL tests/integration/financialPeriod.test.js (6.348 s)
  Financial Period Locking Integration Tests
    Period Management APIs
      ├ù should list all periods (172 ms)
      ├ù should filter periods by status (101 ms)
      ├ù should create new period (94 ms)
      ├ù should prevent overlapping periods (134 ms)
      ├ù should generate periods for fiscal year (100 ms)
      ├ù should lock period (122 ms)
      ├ù should unlock period (53 ms)
      ├ù should close period (153 ms)
      ├ù should prevent unlocking closed period (70 ms)
    Period Locking Enforcement
      ├ù should allow transaction in open period (34 ms)
      ├ù should prevent transaction in locked period (32 ms)
      ├ù should prevent transaction in closed period (29 ms)
    Period Model Methods
      ΓêÜ should check if period contains date (26 ms)
      ├ù should get current open period (30 ms)
      ΓêÜ should prevent modification of closed period (26 ms)

  ΓùÅ Financial Period Locking Integration Tests ΓÇ║ Period Management APIs ΓÇ║ should list all periods

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

    [0m [90m 104 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer 
${authToken}`[39m)[33m;[39m
     [90m 105 |[39m
    [31m[1m>[22m[39m[90m 106 |[39m             
expect(res[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 107 |[39m             
expect(res[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 108 |[39m             
expect(res[33m.[39mbody[33m.[39mdata)[33m.[39mtoHaveLength([35m3[39m)[33m;[39m
     [90m 109 |[39m         })[33m;[39m[0m

      at Object.<anonymous> (tests/integration/financialPeriod.test.js:106:32)

  ΓùÅ Financial Period Locking Integration Tests ΓÇ║ Period Management APIs ΓÇ║ should filter periods by status

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 114 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer 
${authToken}`[39m)[33m;[39m
     [90m 115 |[39m
    [31m[1m>[22m[39m[90m 116 |[39m             
expect(res[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 117 |[39m             
expect(res[33m.[39mbody[33m.[39mdata)[33m.[39mtoHaveLength([35m1[39m)[33m;[39m
     [90m 118 |[39m             
expect(res[33m.[39mbody[33m.[39mdata[[35m0[39m][33m.[39mstatus)[33m.[39mtoBe([32m'open'[39m)[33m;[39m
     [90m 119 |[39m         })[33m;[39m[0m

      at Object.<anonymous> (tests/integration/financialPeriod.test.js:116:32)

  ΓùÅ Financial Period Locking Integration Tests ΓÇ║ Period Management APIs ΓÇ║ should create new period

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 401

    [0m [90m 130 |[39m                 })[33m;[39m
     [90m 131 |[39m
    [31m[1m>[22m[39m[90m 132 |[39m             
expect(res[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 133 |[39m             
expect(res[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 134 |[39m             
expect(res[33m.[39mbody[33m.[39mdata[33m.[39mstatus)[33m.[39mtoBe([32m'open'[39m)[33m;[39m
     [90m 135 |[39m         })[33m;[39m[0m

      at Object.<anonymous> (tests/integration/financialPeriod.test.js:132:32)

  ΓùÅ Financial Period Locking Integration Tests ΓÇ║ Period Management APIs ΓÇ║ should prevent overlapping periods

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 401

    [0m [90m 146 |[39m                 })[33m;[39m
     [90m 147 |[39m
    [31m[1m>[22m[39m[90m 148 |[39m             
expect(res[33m.[39mstatus)[33m.[39mtoBe([35m400[39m)[33m;[39m
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 149 |[39m             
expect(res[33m.[39mbody[33m.[39mmessage)[33m.[39mtoContain([32m'overlap'[39m)[33m;[39m
     [90m 150 |[39m         })[33m;[39m
     [90m 151 |[39m[0m

      at Object.<anonymous> (tests/integration/financialPeriod.test.js:148:32)

  ΓùÅ Financial Period Locking Integration Tests ΓÇ║ Period Management APIs ΓÇ║ should generate periods for fiscal year

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 401

    [0m [90m 155 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer 
${authToken}`[39m)[33m;[39m
     [90m 156 |[39m
    [31m[1m>[22m[39m[90m 157 |[39m             
expect(res[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 158 |[39m             
expect(res[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 159 |[39m             
expect(res[33m.[39mbody[33m.[39mdata)[33m.[39mtoHaveLength([35m12[39m)[33m;[39m [90m// 12 monthly 
periods[39m
     [90m 160 |[39m         })[33m;[39m[0m

      at Object.<anonymous> (tests/integration/financialPeriod.test.js:157:32)

  ΓùÅ Financial Period Locking Integration Tests ΓÇ║ Period Management APIs ΓÇ║ should lock period

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 165 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer 
${authToken}`[39m)[33m;[39m
     [90m 166 |[39m
    [31m[1m>[22m[39m[90m 167 |[39m             
expect(res[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 168 |[39m             
expect(res[33m.[39mbody[33m.[39mdata[33m.[39mstatus)[33m.[39mtoBe([32m'locked'[39m)[33m;[39m
     [90m 169 |[39m             
expect(res[33m.[39mbody[33m.[39mdata[33m.[39mlockedAt)[33m.[39mtoBeDefined()[33m;[39m
     [90m 170 |[39m         })[33m;[39m[0m

      at Object.<anonymous> (tests/integration/financialPeriod.test.js:167:32)

  ΓùÅ Financial Period Locking Integration Tests ΓÇ║ Period Management APIs ΓÇ║ should unlock period

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 175 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer 
${authToken}`[39m)[33m;[39m
     [90m 176 |[39m
    [31m[1m>[22m[39m[90m 177 |[39m             
expect(res[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 178 |[39m             
expect(res[33m.[39mbody[33m.[39mdata[33m.[39mstatus)[33m.[39mtoBe([32m'open'[39m)[33m;[39m
     [90m 179 |[39m         })[33m;[39m
     [90m 180 |[39m[0m

      at Object.<anonymous> (tests/integration/financialPeriod.test.js:177:32)

  ΓùÅ Financial Period Locking Integration Tests ΓÇ║ Period Management APIs ΓÇ║ should close period

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 194 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer 
${authToken}`[39m)[33m;[39m
     [90m 195 |[39m
    [31m[1m>[22m[39m[90m 196 |[39m             
expect(res[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 197 |[39m             
expect(res[33m.[39mbody[33m.[39mdata[33m.[39mstatus)[33m.[39mtoBe([32m'closed'[39m)[33m;[39m
     [90m 198 |[39m             
expect(res[33m.[39mbody[33m.[39mdata[33m.[39mclosedAt)[33m.[39mtoBeDefined()[33m;[39m
     [90m 199 |[39m         })[33m;[39m[0m

      at Object.<anonymous> (tests/integration/financialPeriod.test.js:196:32)

  ΓùÅ Financial Period Locking Integration Tests ΓÇ║ Period Management APIs ΓÇ║ should prevent unlocking closed period

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 401

    [0m [90m 204 |[39m                 [33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m [32m`Bearer 
${authToken}`[39m)[33m;[39m
     [90m 205 |[39m
    [31m[1m>[22m[39m[90m 206 |[39m             
expect(res[33m.[39mstatus)[33m.[39mtoBe([35m400[39m)[33m;[39m
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 207 |[39m             
expect(res[33m.[39mbody[33m.[39mmessage)[33m.[39mtoContain([32m'closed'[39m)[33m;[39m
     [90m 208 |[39m         })[33m;[39m
     [90m 209 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (tests/integration/financialPeriod.test.js:206:32)

  ΓùÅ Financial Period Locking Integration Tests ΓÇ║ Period Locking Enforcement ΓÇ║ should allow transaction in open 
period

    TypeError: Cannot read properties of null (reading 'status')

    [0m [90m 219 |[39m
     [90m 220 |[39m             expect(period)[33m.[39mtoBeDefined()[33m;[39m
    [31m[1m>[22m[39m[90m 221 |[39m             
expect(period[33m.[39mstatus)[33m.[39mtoBe([32m'open'[39m)[33m;[39m
     [90m     |[39m                           [31m[1m^[22m[39m
     [90m 222 |[39m             expect(period[33m.[39misOpen())[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 223 |[39m         })[33m;[39m
     [90m 224 |[39m[0m

      at Object.<anonymous> (tests/integration/financialPeriod.test.js:221:27)

  ΓùÅ Financial Period Locking Integration Tests ΓÇ║ Period Locking Enforcement ΓÇ║ should prevent transaction in 
locked period

    TypeError: Cannot read properties of null (reading 'status')

    [0m [90m 230 |[39m
     [90m 231 |[39m             expect(period)[33m.[39mtoBeDefined()[33m;[39m
    [31m[1m>[22m[39m[90m 232 |[39m             
expect(period[33m.[39mstatus)[33m.[39mtoBe([32m'locked'[39m)[33m;[39m
     [90m     |[39m                           [31m[1m^[22m[39m
     [90m 233 |[39m             expect(period[33m.[39misOpen())[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 234 |[39m         })[33m;[39m
     [90m 235 |[39m[0m

      at Object.<anonymous> (tests/integration/financialPeriod.test.js:232:27)

  ΓùÅ Financial Period Locking Integration Tests ΓÇ║ Period Locking Enforcement ΓÇ║ should prevent transaction in 
closed period

    TypeError: Cannot read properties of null (reading 'status')

    [0m [90m 241 |[39m
     [90m 242 |[39m             expect(period)[33m.[39mtoBeDefined()[33m;[39m
    [31m[1m>[22m[39m[90m 243 |[39m             
expect(period[33m.[39mstatus)[33m.[39mtoBe([32m'closed'[39m)[33m;[39m
     [90m     |[39m                           [31m[1m^[22m[39m
     [90m 244 |[39m             expect(period[33m.[39misOpen())[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 245 |[39m         })[33m;[39m
     [90m 246 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (tests/integration/financialPeriod.test.js:243:27)

  ΓùÅ Financial Period Locking Integration Tests ΓÇ║ Period Model Methods ΓÇ║ should get current open period

    TypeError: Cannot read properties of null (reading 'status')

    [0m [90m 256 |[39m
     [90m 257 |[39m             expect(currentPeriod)[33m.[39mtoBeDefined()[33m;[39m
    [31m[1m>[22m[39m[90m 258 |[39m             
expect(currentPeriod[33m.[39mstatus)[33m.[39mtoBe([32m'open'[39m)[33m;[39m
     [90m     |[39m                                  [31m[1m^[22m[39m
     [90m 259 |[39m         })[33m;[39m
     [90m 260 |[39m
     [90m 261 |[39m         test([32m'should prevent modification of closed period'[39m[33m,[39m [36masync[39m 
() [33m=>[39m {[0m

      at Object.<anonymous> (tests/integration/financialPeriod.test.js:258:34)

(node:19080) [MONGOOSE] Warning: Duplicate schema index on {"subdomain":1} found. This is often due to declaring an 
index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:19080) [MONGOOSE] Warning: Duplicate schema index on {"entryNumber":1} found. This is often due to declaring an 
index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:19080) [MONGODB DRIVER] Warning: useNewUrlParser is a deprecated option: useNewUrlParser has no effect since 
Node.js Driver version 4.0.0 and will be removed in the next major version
(node:19080) [MONGODB DRIVER] Warning: useUnifiedTopology is a deprecated option: useUnifiedTopology has no effect 
since Node.js Driver version 4.0.0 and will be removed in the next major version
  console.log
    ≡ƒôà Creating default financial periods...

      at migrations/003-create-default-financial-period.js:20:21

  console.error
    Γ¥î Migration failed: MongoServerError: Transaction numbers are only allowed on a replica set member or mongos
        at Connection.sendCommand (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cmap\connection.ts:559:17)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at Connection.command (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cmap\connection.ts:633:22)
        at Server.command (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\sdam\server.ts:350:21)
        at tryOperation (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\operations\execute_operation.ts:289:24)
        at executeOperation (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\operations\execute_operation.ts:119:12)
        at FindCursor._initialize (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cursor\find_cursor.ts:92:22)
        at FindCursor.cursorInit (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cursor\abstract_cursor.ts:949:21)
        at FindCursor.fetchBatch (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cursor\abstract_cursor.ts:987:7)
        at FindCursor.next (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cursor\abstract_cursor.ts:608:9)
        at FindCursor.[Symbol.asyncIterator] (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cursor\abstract_cursor.ts:502:26)
        at FindCursor.toArray (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cursor\abstract_cursor.ts:696:22)
        at model.Query._find (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\lib\query.js:2430:14)
        at model.Query.exec (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\lib\query.js:4627:63)
        at F:\Inventory Management\Tushar's Code\BizzAI\backend\migrations\003-create-default-financial-period.js:23:35
        at ClientSession.withTransaction (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\sessions.ts:750:20)
        at Object.up (F:\Inventory Management\Tushar's Code\BizzAI\backend\migrations\003-create-default-financial-period.js:19:9)
        at Object.<anonymous> (F:\Inventory Management\Tushar's Code\BizzAI\backend\tests\integration\migrations.test.js:54:13) {
      errorLabelSet: Set(0) {},
      errorResponse: {
        ok: 0,
        errmsg: 'Transaction numbers are only allowed on a replica set member or mongos',
        code: 20,
        codeName: 'IllegalOperation'
      },
      ok: 0,
      code: 20,
      codeName: 'IllegalOperation'
    }

    [0m [90m  96 |[39m         })[33m;[39m
     [90m  97 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m  98 |[39m         console[33m.[39merror([32m'Γ¥î Migration failed:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m  99 |[39m         [36mthrow[39m error[33m;[39m
     [90m 100 |[39m     } [36mfinally[39m {
     [90m 101 |[39m         session[33m.[39mendSession()[33m;[39m[0m

      at Object.up (migrations/003-create-default-financial-period.js:98:17)
      at Object.<anonymous> (tests/integration/migrations.test.js:54:13)

  console.log
    ≡ƒôà Creating default financial periods...

      at migrations/003-create-default-financial-period.js:20:21

  console.error
    Γ¥î Migration failed: MongoServerError: Transaction numbers are only allowed on a replica set member or mongos
        at Connection.sendCommand (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cmap\connection.ts:559:17)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at Connection.command (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cmap\connection.ts:633:22)
        at Server.command (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\sdam\server.ts:350:21)
        at tryOperation (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\operations\execute_operation.ts:289:24)
        at executeOperation (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\operations\execute_operation.ts:119:12)
        at FindCursor._initialize (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cursor\find_cursor.ts:92:22)
        at FindCursor.cursorInit (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cursor\abstract_cursor.ts:949:21)
        at FindCursor.fetchBatch (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cursor\abstract_cursor.ts:987:7)
        at FindCursor.next (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cursor\abstract_cursor.ts:608:9)
        at FindCursor.[Symbol.asyncIterator] (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cursor\abstract_cursor.ts:502:26)
        at FindCursor.toArray (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cursor\abstract_cursor.ts:696:22)
        at model.Query._find (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\lib\query.js:2430:14)
        at model.Query.exec (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\lib\query.js:4627:63)
        at F:\Inventory Management\Tushar's Code\BizzAI\backend\migrations\003-create-default-financial-period.js:23:35
        at ClientSession.withTransaction (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\sessions.ts:750:20)
        at Object.up (F:\Inventory Management\Tushar's Code\BizzAI\backend\migrations\003-create-default-financial-period.js:19:9)
        at Object.<anonymous> (F:\Inventory Management\Tushar's Code\BizzAI\backend\tests\integration\migrations.test.js:93:13) {
      errorLabelSet: Set(0) {},
      errorResponse: {
        ok: 0,
        errmsg: 'Transaction numbers are only allowed on a replica set member or mongos',
        code: 20,
        codeName: 'IllegalOperation'
      },
      ok: 0,
      code: 20,
      codeName: 'IllegalOperation'
    }

    [0m [90m  96 |[39m         })[33m;[39m
     [90m  97 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m  98 |[39m         console[33m.[39merror([32m'Γ¥î Migration failed:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m  99 |[39m         [36mthrow[39m error[33m;[39m
     [90m 100 |[39m     } [36mfinally[39m {
     [90m 101 |[39m         session[33m.[39mendSession()[33m;[39m[0m

      at Object.up (migrations/003-create-default-financial-period.js:98:17)
      at Object.<anonymous> (tests/integration/migrations.test.js:93:13)

  console.log
    ≡ƒôà Creating default financial periods...

      at migrations/003-create-default-financial-period.js:20:21

  console.error
    Γ¥î Migration failed: MongoServerError: Transaction numbers are only allowed on a replica set member or mongos
        at Connection.sendCommand (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cmap\connection.ts:559:17)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at Connection.command (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cmap\connection.ts:633:22)
        at Server.command (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\sdam\server.ts:350:21)
        at tryOperation (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\operations\execute_operation.ts:289:24)
        at executeOperation (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\operations\execute_operation.ts:119:12)
        at FindCursor._initialize (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cursor\find_cursor.ts:92:22)
        at FindCursor.cursorInit (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cursor\abstract_cursor.ts:949:21)
        at FindCursor.fetchBatch (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cursor\abstract_cursor.ts:987:7)
        at FindCursor.next (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cursor\abstract_cursor.ts:608:9)
        at FindCursor.[Symbol.asyncIterator] (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cursor\abstract_cursor.ts:502:26)
        at FindCursor.toArray (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cursor\abstract_cursor.ts:696:22)
        at model.Query._find (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\lib\query.js:2430:14)
        at model.Query.exec (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\lib\query.js:4627:63)
        at F:\Inventory Management\Tushar's Code\BizzAI\backend\migrations\003-create-default-financial-period.js:23:35
        at ClientSession.withTransaction (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\sessions.ts:750:20)
        at Object.up (F:\Inventory Management\Tushar's Code\BizzAI\backend\migrations\003-create-default-financial-period.js:19:9)
        at Object.<anonymous> (F:\Inventory Management\Tushar's Code\BizzAI\backend\tests\integration\migrations.test.js:107:13) {
      errorLabelSet: Set(0) {},
      errorResponse: {
        ok: 0,
        errmsg: 'Transaction numbers are only allowed on a replica set member or mongos',
        code: 20,
        codeName: 'IllegalOperation'
      },
      ok: 0,
      code: 20,
      codeName: 'IllegalOperation'
    }

    [0m [90m  96 |[39m         })[33m;[39m
     [90m  97 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m  98 |[39m         console[33m.[39merror([32m'Γ¥î Migration failed:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m  99 |[39m         [36mthrow[39m error[33m;[39m
     [90m 100 |[39m     } [36mfinally[39m {
     [90m 101 |[39m         session[33m.[39mendSession()[33m;[39m[0m

      at Object.up (migrations/003-create-default-financial-period.js:98:17)
      at Object.<anonymous> (tests/integration/migrations.test.js:107:13)

  console.log
    ≡ƒÅó Adding organizationId to all models...

      at migrations/004-add-organization-to-all-models.js:31:21

  console.error
    Γ¥î Migration failed: MongoServerError: Transaction numbers are only allowed on a replica set member or mongos
        at Connection.sendCommand (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cmap\connection.ts:559:17)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at Connection.command (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cmap\connection.ts:633:22)
        at Server.command (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\sdam\server.ts:350:21)
        at tryOperation (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\operations\execute_operation.ts:289:24)
        at executeOperation (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\operations\execute_operation.ts:119:12)
        at FindCursor._initialize (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cursor\find_cursor.ts:92:22)
        at FindCursor.cursorInit (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cursor\abstract_cursor.ts:949:21)
        at FindCursor.fetchBatch (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cursor\abstract_cursor.ts:987:7)
        at FindCursor.next (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\cursor\abstract_cursor.ts:608:9)
        at Collection.findOne (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\collection.ts:552:20)
        at model.Query._findOne (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\lib\query.js:2710:15)
        at model.Query.exec (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\lib\query.js:4627:63)
        at F:\Inventory Management\Tushar's Code\BizzAI\backend\migrations\004-add-organization-to-all-models.js:34:32
        at ClientSession.withTransaction (F:\Inventory Management\Tushar's Code\BizzAI\backend\node_modules\mongoose\node_modules\mongodb\src\sessions.ts:750:20)
        at Object.up (F:\Inventory Management\Tushar's Code\BizzAI\backend\migrations\004-add-organization-to-all-models.js:30:9)
        at Object.<anonymous> (F:\Inventory Management\Tushar's Code\BizzAI\backend\tests\integration\migrations.test.js:160:13) {
      errorLabelSet: Set(0) {},
      errorResponse: {
        ok: 0,
        errmsg: 'Transaction numbers are only allowed on a replica set member or mongos',
        code: 20,
        codeName: 'IllegalOperation'
      },
      ok: 0,
      code: 20,
      codeName: 'IllegalOperation'
    }

    [0m [90m 82 |[39m         })[33m;[39m
     [90m 83 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 84 |[39m         console[33m.[39merror([32m'Γ¥î Migration failed:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 85 |[39m         [36mthrow[39m error[33m;[39m
     [90m 86 |[39m     } [36mfinally[39m {
     [90m 87 |[39m         session[33m.[39mendSession()[33m;[39m[0m

      at Object.up (migrations/004-add-organization-to-all-models.js:84:17)
      at Object.<anonymous> (tests/integration/migrations.test.js:160:13)

FAIL tests/integration/migrations.test.js
  Migration Tests
    Migration 003: Create Default Financial Period
      ├ù should create default financial period for organization (513 ms)
      ├ù should assign existing journal entries to default period (284 ms)
      ├ù should rollback correctly (195 ms)
      ├ù should be idempotent (151 ms)
    Migration 004: Add Organization to All Models
      ├ù should add organizationId to items (138 ms)
      ├ù should add organizationId to invoices (143 ms)
      ├ù should create indexes for organizationId (146 ms)
      ├ù should assign documents to default organization (145 ms)
      ├ù should rollback correctly (130 ms)
      ├ù should handle large datasets efficiently (164 ms)
    Migration Safety
      ├ù should not lose data during migration (131 ms)
      ├ù should maintain referential integrity (134 ms)

  ΓùÅ Migration Tests ΓÇ║ Migration 003: Create Default Financial Period ΓÇ║ should create default financial period 
for organization

    MongoServerError: Transaction numbers are only allowed on a replica set member or mongos

    [0m [90m 21 |[39m
     [90m 22 |[39m             [90m// Get all organizations[39m
    [31m[1m>[22m[39m[90m 23 |[39m             [36mconst[39m organizations [33m=[39m [36mawait[39m 
[33mOrganization[39m[33m.[39mfind({})[33m.[39msession(session)[33m;[39m
     [90m    |[39m                                   [31m[1m^[22m[39m
     [90m 24 |[39m
     [90m 25 |[39m             [36mif[39m (organizations[33m.[39mlength [33m===[39m [35m0[39m) {
     [90m 26 |[39m                 console[33m.[39mlog([32m'ΓÜá∩╕Å  No organizations found. Skipping period 
creation.'[39m)[33m;[39m[0m

      at Connection.sendCommand (node_modules/mongoose/node_modules/mongodb/src/cmap/connection.ts:559:17)
      at Connection.command (node_modules/mongoose/node_modules/mongodb/src/cmap/connection.ts:633:22)
      at Server.command (node_modules/mongoose/node_modules/mongodb/src/sdam/server.ts:350:21)
      at tryOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:289:24)
      at executeOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:119:12)
      at FindCursor._initialize (node_modules/mongoose/node_modules/mongodb/src/cursor/find_cursor.ts:92:22)
      at FindCursor.cursorInit (node_modules/mongoose/node_modules/mongodb/src/cursor/abstract_cursor.ts:949:21)
      at FindCursor.fetchBatch (node_modules/mongoose/node_modules/mongodb/src/cursor/abstract_cursor.ts:987:7)
      at FindCursor.next (node_modules/mongoose/node_modules/mongodb/src/cursor/abstract_cursor.ts:608:9)
      at FindCursor.[Symbol.asyncIterator] 
(node_modules/mongoose/node_modules/mongodb/src/cursor/abstract_cursor.ts:502:26)
      at FindCursor.toArray (node_modules/mongoose/node_modules/mongodb/src/cursor/abstract_cursor.ts:696:22)
      at model.Query._find (node_modules/mongoose/lib/query.js:2430:14)
      at model.Query.exec (node_modules/mongoose/lib/query.js:4627:63)
      at migrations/003-create-default-financial-period.js:23:35
      at ClientSession.withTransaction (node_modules/mongoose/node_modules/mongodb/src/sessions.ts:750:20)
      at Object.up (migrations/003-create-default-financial-period.js:19:9)
      at Object.<anonymous> (tests/integration/migrations.test.js:54:13)

  ΓùÅ Migration Tests ΓÇ║ Migration 003: Create Default Financial Period ΓÇ║ should assign existing journal entries to 
default period

    ValidationError: JournalEntry validation failed: financialPeriod: Path `financialPeriod` is required., 
sourceDocument.type: Path `sourceDocument.type` is required.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3373:32)
      at node_modules/mongoose/lib/document.js:3134:17
      at node_modules/mongoose/lib/schemaType.js:1446:9

  ΓùÅ Migration Tests ΓÇ║ Migration 003: Create Default Financial Period ΓÇ║ should rollback correctly

    MongoServerError: Transaction numbers are only allowed on a replica set member or mongos

    [0m [90m 21 |[39m
     [90m 22 |[39m             [90m// Get all organizations[39m
    [31m[1m>[22m[39m[90m 23 |[39m             [36mconst[39m organizations [33m=[39m [36mawait[39m 
[33mOrganization[39m[33m.[39mfind({})[33m.[39msession(session)[33m;[39m
     [90m    |[39m                                   [31m[1m^[22m[39m
     [90m 24 |[39m
     [90m 25 |[39m             [36mif[39m (organizations[33m.[39mlength [33m===[39m [35m0[39m) {
     [90m 26 |[39m                 console[33m.[39mlog([32m'ΓÜá∩╕Å  No organizations found. Skipping period 
creation.'[39m)[33m;[39m[0m

      at Connection.sendCommand (node_modules/mongoose/node_modules/mongodb/src/cmap/connection.ts:559:17)
      at Connection.command (node_modules/mongoose/node_modules/mongodb/src/cmap/connection.ts:633:22)
      at Server.command (node_modules/mongoose/node_modules/mongodb/src/sdam/server.ts:350:21)
      at tryOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:289:24)
      at executeOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:119:12)
      at FindCursor._initialize (node_modules/mongoose/node_modules/mongodb/src/cursor/find_cursor.ts:92:22)
      at FindCursor.cursorInit (node_modules/mongoose/node_modules/mongodb/src/cursor/abstract_cursor.ts:949:21)
      at FindCursor.fetchBatch (node_modules/mongoose/node_modules/mongodb/src/cursor/abstract_cursor.ts:987:7)
      at FindCursor.next (node_modules/mongoose/node_modules/mongodb/src/cursor/abstract_cursor.ts:608:9)
      at FindCursor.[Symbol.asyncIterator] 
(node_modules/mongoose/node_modules/mongodb/src/cursor/abstract_cursor.ts:502:26)
      at FindCursor.toArray (node_modules/mongoose/node_modules/mongodb/src/cursor/abstract_cursor.ts:696:22)
      at model.Query._find (node_modules/mongoose/lib/query.js:2430:14)
      at model.Query.exec (node_modules/mongoose/lib/query.js:4627:63)
      at migrations/003-create-default-financial-period.js:23:35
      at ClientSession.withTransaction (node_modules/mongoose/node_modules/mongodb/src/sessions.ts:750:20)
      at Object.up (migrations/003-create-default-financial-period.js:19:9)
      at Object.<anonymous> (tests/integration/migrations.test.js:93:13)

  ΓùÅ Migration Tests ΓÇ║ Migration 003: Create Default Financial Period ΓÇ║ should be idempotent

    MongoServerError: Transaction numbers are only allowed on a replica set member or mongos

    [0m [90m 21 |[39m
     [90m 22 |[39m             [90m// Get all organizations[39m
    [31m[1m>[22m[39m[90m 23 |[39m             [36mconst[39m organizations [33m=[39m [36mawait[39m 
[33mOrganization[39m[33m.[39mfind({})[33m.[39msession(session)[33m;[39m
     [90m    |[39m                                   [31m[1m^[22m[39m
     [90m 24 |[39m
     [90m 25 |[39m             [36mif[39m (organizations[33m.[39mlength [33m===[39m [35m0[39m) {
     [90m 26 |[39m                 console[33m.[39mlog([32m'ΓÜá∩╕Å  No organizations found. Skipping period 
creation.'[39m)[33m;[39m[0m

      at Connection.sendCommand (node_modules/mongoose/node_modules/mongodb/src/cmap/connection.ts:559:17)
      at Connection.command (node_modules/mongoose/node_modules/mongodb/src/cmap/connection.ts:633:22)
      at Server.command (node_modules/mongoose/node_modules/mongodb/src/sdam/server.ts:350:21)
      at tryOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:289:24)
      at executeOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:119:12)
      at FindCursor._initialize (node_modules/mongoose/node_modules/mongodb/src/cursor/find_cursor.ts:92:22)
      at FindCursor.cursorInit (node_modules/mongoose/node_modules/mongodb/src/cursor/abstract_cursor.ts:949:21)
      at FindCursor.fetchBatch (node_modules/mongoose/node_modules/mongodb/src/cursor/abstract_cursor.ts:987:7)
      at FindCursor.next (node_modules/mongoose/node_modules/mongodb/src/cursor/abstract_cursor.ts:608:9)
      at FindCursor.[Symbol.asyncIterator] 
(node_modules/mongoose/node_modules/mongodb/src/cursor/abstract_cursor.ts:502:26)
      at FindCursor.toArray (node_modules/mongoose/node_modules/mongodb/src/cursor/abstract_cursor.ts:696:22)
      at model.Query._find (node_modules/mongoose/lib/query.js:2430:14)
      at model.Query.exec (node_modules/mongoose/lib/query.js:4627:63)
      at migrations/003-create-default-financial-period.js:23:35
      at ClientSession.withTransaction (node_modules/mongoose/node_modules/mongodb/src/sessions.ts:750:20)
      at Object.up (migrations/003-create-default-financial-period.js:19:9)
      at Object.<anonymous> (tests/integration/migrations.test.js:107:13)

  ΓùÅ Migration Tests ΓÇ║ Migration 004: Add Organization to All Models ΓÇ║ should add organizationId to items

    ValidationError: Item validation failed: addedBy: Path `addedBy` is required., costPrice: Path `costPrice` is 
required.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3373:32)
      at node_modules/mongoose/lib/document.js:3134:17
      at node_modules/mongoose/lib/schemaType.js:1446:9

  ΓùÅ Migration Tests ΓÇ║ Migration 004: Add Organization to All Models ΓÇ║ should add organizationId to invoices

    ValidationError: Invoice validation failed: subtotal: Path `subtotal` is required., items.0.total: Path `total` is 
required., items.0.price: Path `price` is required., items.0.item: Path `item` is required.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3373:32)
      at node_modules/mongoose/lib/document.js:3134:17
      at node_modules/mongoose/lib/schemaType.js:1446:9

  ΓùÅ Migration Tests ΓÇ║ Migration 004: Add Organization to All Models ΓÇ║ should create indexes for organizationId

    MongoServerError: Transaction numbers are only allowed on a replica set member or mongos

    [0m [90m 32 |[39m
     [90m 33 |[39m             [90m// Get default organization[39m
    [31m[1m>[22m[39m[90m 34 |[39m             [36mconst[39m defaultOrg [33m=[39m [36mawait[39m 
[33mOrganization[39m[33m.[39mfindOne({})[33m.[39msession(session)[33m;[39m
     [90m    |[39m                                [31m[1m^[22m[39m
     [90m 35 |[39m
     [90m 36 |[39m             [36mif[39m ([33m![39mdefaultOrg) {
     [90m 37 |[39m                 [36mthrow[39m [36mnew[39m [33mError[39m([32m'No organization found. Please 
run migration 001 first.'[39m)[33m;[39m[0m

      at Connection.sendCommand (node_modules/mongoose/node_modules/mongodb/src/cmap/connection.ts:559:17)
      at Connection.command (node_modules/mongoose/node_modules/mongodb/src/cmap/connection.ts:633:22)
      at Server.command (node_modules/mongoose/node_modules/mongodb/src/sdam/server.ts:350:21)
      at tryOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:289:24)
      at executeOperation (node_modules/mongoose/node_modules/mongodb/src/operations/execute_operation.ts:119:12)
      at FindCursor._initialize (node_modules/mongoose/node_modules/mongodb/src/cursor/find_cursor.ts:92:22)
      at FindCursor.cursorInit (node_modules/mongoose/node_modules/mongodb/src/cursor/abstract_cursor.ts:949:21)
      at FindCursor.fetchBatch (node_modules/mongoose/node_modules/mongodb/src/cursor/abstract_cursor.ts:987:7)
      at FindCursor.next (node_modules/mongoose/node_modules/mongodb/src/cursor/abstract_cursor.ts:608:9)
      at Collection.findOne (node_modules/mongoose/node_modules/mongodb/src/collection.ts:552:20)
      at model.Query._findOne (node_modules/mongoose/lib/query.js:2710:15)
      at model.Query.exec (node_modules/mongoose/lib/query.js:4627:63)
      at migrations/004-add-organization-to-all-models.js:34:32
      at ClientSession.withTransaction (node_modules/mongoose/node_modules/mongodb/src/sessions.ts:750:20)
      at Object.up (migrations/004-add-organization-to-all-models.js:30:9)
      at Object.<anonymous> (tests/integration/migrations.test.js:160:13)

  ΓùÅ Migration Tests ΓÇ║ Migration 004: Add Organization to All Models ΓÇ║ should assign documents to default 
organization

    ValidationError: Item validation failed: addedBy: Path `addedBy` is required., costPrice: Path `costPrice` is 
required.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3373:32)
      at node_modules/mongoose/lib/document.js:3134:17
      at node_modules/mongoose/lib/schemaType.js:1446:9

  ΓùÅ Migration Tests ΓÇ║ Migration 004: Add Organization to All Models ΓÇ║ should rollback correctly

    ValidationError: Item validation failed: addedBy: Path `addedBy` is required., costPrice: Path `costPrice` is 
required.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3373:32)
      at node_modules/mongoose/lib/document.js:3134:17
      at node_modules/mongoose/lib/schemaType.js:1446:9

  ΓùÅ Migration Tests ΓÇ║ Migration 004: Add Organization to All Models ΓÇ║ should handle large datasets efficiently

    ValidationError: Item validation failed: addedBy: Path `addedBy` is required., costPrice: Path `costPrice` is 
required.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3373:32)
      at node_modules/mongoose/lib/document.js:3134:17
      at node_modules/mongoose/lib/schemaType.js:1446:9

  ΓùÅ Migration Tests ΓÇ║ Migration Safety ΓÇ║ should not lose data during migration

    ValidationError: Item validation failed: addedBy: Path `addedBy` is required., costPrice: Path `costPrice` is 
required.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3373:32)
      at node_modules/mongoose/lib/document.js:3134:17
      at node_modules/mongoose/lib/schemaType.js:1446:9

  ΓùÅ Migration Tests ΓÇ║ Migration Safety ΓÇ║ should maintain referential integrity

    ValidationError: Invoice validation failed: subtotal: Path `subtotal` is required., items.0.total: Path `total` is 
required., items.0.price: Path `price` is required., items.0.item: Path `item` is required.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3373:32)
      at node_modules/mongoose/lib/document.js:3134:17
      at node_modules/mongoose/lib/schemaType.js:1446:9

(node:19080) [MONGOOSE] Warning: Duplicate schema index on {"subdomain":1} found. This is often due to declaring an 
index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:19080) [MONGODB DRIVER] Warning: useNewUrlParser is a deprecated option: useNewUrlParser has no effect since 
Node.js Driver version 4.0.0 and will be removed in the next major version
(node:19080) [MONGODB DRIVER] Warning: useUnifiedTopology is a deprecated option: useUnifiedTopology has no effect 
since Node.js Driver version 4.0.0 and will be removed in the next major version
  console.log
    Concurrent oversells: 0 succeeded, 5 failed

      at Object.<anonymous> (tests/integration/concurrency.test.js:130:21)

FAIL tests/integration/concurrency.test.js
  ΓùÅ Concurrency Tests ΓÇ║ Concurrent Stock Updates ΓÇ║ should handle concurrent stock ledger entries correctly

    expect(received).toBe(expected) // Object.is equality

    Expected: 50
    Received: undefined

    [0m [90m 91 |[39m             [90m// Verify final stock[39m
     [90m 92 |[39m             [36mconst[39m finalItem [33m=[39m [36mawait[39m 
[33mItem[39m[33m.[39mfindById(item[33m.[39m_id)[33m;[39m
    [31m[1m>[22m[39m[90m 93 |[39m             
expect(finalItem[33m.[39mcurrentStock)[33m.[39mtoBe([35m50[39m)[33m;[39m [90m// 100 - (10 * 5)[39m
     [90m    |[39m                                            [31m[1m^[22m[39m
     [90m 94 |[39m         })[33m;[39m
     [90m 95 |[39m
     [90m 96 |[39m         test([32m'should prevent race conditions in stock updates'[39m[33m,[39m 
[36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (tests/integration/concurrency.test.js:93:44)

  ΓùÅ Concurrency Tests ΓÇ║ Concurrent Stock Updates ΓÇ║ should prevent race conditions in stock updates

    expect(received).toBeGreaterThanOrEqual(expected)

    Matcher error: received value must be a number or bigint

    Received has value: undefined

    [0m [90m 132 |[39m             [90m// Final stock should never be negative[39m
     [90m 133 |[39m             [36mconst[39m finalItem [33m=[39m [36mawait[39m 
[33mItem[39m[33m.[39mfindById(item[33m.[39m_id)[33m;[39m
    [31m[1m>[22m[39m[90m 134 |[39m             
expect(finalItem[33m.[39mcurrentStock)[33m.[39mtoBeGreaterThanOrEqual([35m0[39m)[33m;[39m
     [90m     |[39m                                            [31m[1m^[22m[39m
     [90m 135 |[39m         })[33m;[39m
     [90m 136 |[39m     })[33m;[39m
     [90m 137 |[39m[0m

      at Object.<anonymous> (tests/integration/concurrency.test.js:134:44)

  ΓùÅ Concurrency Tests ΓÇ║ Concurrent Invoice Creation ΓÇ║ should handle concurrent invoice creation with unique 
numbers

    expect(received).toBe(expected) // Object.is equality

    Expected: 20
    Received: 0

    [0m [90m 154 |[39m
     [90m 155 |[39m             [36mconst[39m successful [33m=[39m results[33m.[39mfilter(r [33m=>[39m 
r[33m.[39mstatus [33m===[39m [32m'fulfilled'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 156 |[39m             
expect(successful[33m.[39mlength)[33m.[39mtoBe([35m20[39m)[33m;[39m
     [90m     |[39m                                       [31m[1m^[22m[39m
     [90m 157 |[39m
     [90m 158 |[39m             [90m// Verify all have unique invoice numbers[39m
     [90m 159 |[39m             [36mconst[39m created [33m=[39m successful[33m.[39mmap(r [33m=>[39m 
r[33m.[39mvalue)[33m;[39m[0m

      at Object.<anonymous> (tests/integration/concurrency.test.js:156:39)

  ΓùÅ Concurrency Tests ΓÇ║ Transaction Isolation ΓÇ║ should maintain isolation between concurrent transactions

    ValidationError: StockLedger validation failed: sourceDocument.id: Path `sourceDocument.id` is required., 
sourceDocument.type: Path `sourceDocument.type` is required., transactionType: `sale` is not a valid enum value for 
path `transactionType`.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3373:32)
      at node_modules/mongoose/lib/document.js:3134:17
      at node_modules/mongoose/lib/schemaType.js:1446:9

  ΓùÅ Concurrency Tests ΓÇ║ Transaction Isolation ΓÇ║ should rollback failed transactions without affecting others

    expect(received).toBe(expected) // Object.is equality

    Expected: 45
    Received: undefined

    [0m [90m 396 |[39m             [90m// Only successful transaction should affect stock[39m
     [90m 397 |[39m             [36mconst[39m finalItem [33m=[39m [36mawait[39m 
[33mItem[39m[33m.[39mfindById(item[33m.[39m_id)[33m;[39m
    [31m[1m>[22m[39m[90m 398 |[39m             
expect(finalItem[33m.[39mcurrentStock)[33m.[39mtoBe([35m45[39m)[33m;[39m [90m// 50 - 5 (failed transaction 
rolled back)[39m
     [90m     |[39m                                            [31m[1m^[22m[39m
     [90m 399 |[39m         })[33m;[39m
     [90m 400 |[39m     })[33m;[39m
     [90m 401 |[39m[0m

      at Object.<anonymous> (tests/integration/concurrency.test.js:398:44)

  ΓùÅ Concurrency Tests ΓÇ║ Deadlock Prevention ΓÇ║ should handle potential deadlocks gracefully

    expect(received).toBeLessThan(expected)

    Matcher error: received value must be a number or bigint

    Received has value: undefined

    [0m [90m 516 |[39m             [36mconst[39m finalItem2 [33m=[39m [36mawait[39m 
[33mItem[39m[33m.[39mfindById(item2[33m.[39m_id)[33m;[39m
     [90m 517 |[39m
    [31m[1m>[22m[39m[90m 518 |[39m             
expect(finalItem1[33m.[39mcurrentStock)[33m.[39mtoBeLessThan([35m100[39m)[33m;[39m
     [90m     |[39m                                             [31m[1m^[22m[39m
     [90m 519 |[39m             
expect(finalItem2[33m.[39mcurrentStock)[33m.[39mtoBeLessThan([35m100[39m)[33m;[39m
     [90m 520 |[39m         })[33m;[39m
     [90m 521 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (tests/integration/concurrency.test.js:518:45)


  ΓùÅ Test suite failed to run

    StockLedger entries cannot be deleted

    [0m [90m 183 |[39m
     [90m 184 |[39m stockLedgerSchema[33m.[39mpre([32m'deleteMany'[39m[33m,[39m [36mfunction[39m (next) {
    [31m[1m>[22m[39m[90m 185 |[39m     next([36mnew[39m [33mError[39m([32m'StockLedger entries cannot be 
deleted'[39m))[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 186 |[39m })[33m;[39m
     [90m 187 |[39m
     [90m 188 |[39m [90m// Virtual for absolute quantity change[39m[0m

      at model.Query.<anonymous> (models/StockLedger.js:185:10)
      at callMiddlewareFunction (node_modules/kareem/index.js:628:27)
      at next (node_modules/kareem/index.js:93:7)
      at Kareem.Object.<anonymous>.Kareem.execPre (node_modules/kareem/index.js:122:8)
      at node_modules/mongoose/lib/query.js:4715:28
      at _executePreHooks (node_modules/mongoose/lib/query.js:4714:10)
      at model.Query.exec (node_modules/mongoose/lib/query.js:4626:11)
      at Object.<anonymous> (tests/integration/concurrency.test.js:48:9)

(node:19080) [MONGOOSE] Warning: Duplicate schema index on {"subdomain":1} found. This is often due to declaring an 
index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:19080) [MONGOOSE] Warning: Duplicate schema index on {"code":1} found. This is often due to declaring an index 
using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:19080) [MONGOOSE] Warning: Duplicate schema index on {"entryNumber":1} found. This is often due to declaring an 
index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:19080) [MONGODB DRIVER] Warning: useNewUrlParser is a deprecated option: useNewUrlParser has no effect since 
Node.js Driver version 4.0.0 and will be removed in the next major version
(node:19080) [MONGODB DRIVER] Warning: useUnifiedTopology is a deprecated option: useUnifiedTopology has no effect 
since Node.js Driver version 4.0.0 and will be removed in the next major version
FAIL tests/integration/autoPosting.test.js
  Auto-Posting Service Integration Tests
    Purchase Auto-Posting
      ├ù should create journal entry for cash purchase (89 ms)
      ├ù should create journal entry for credit purchase (61 ms)
      ΓêÜ should reject posting to locked period (23 ms)
      ΓêÜ should reject posting without financial period (12 ms)
    Sale Auto-Posting
      ├ù should create revenue and COGS journal entries (16 ms)
      ├ù should handle credit sales correctly (14 ms)
    Payment Auto-Posting
      ├ù should create journal entry for payment (10 ms)
    Transaction Safety
      ├ù should rollback on error (20 ms)

  ΓùÅ Auto-Posting Service Integration Tests ΓÇ║ Purchase Auto-Posting ΓÇ║ should create journal entry for cash 
purchase

    Failed to post purchase: Required accounts not found

    [0m [90m 93 |[39m
     [90m 94 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 95 |[39m         [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to post 
purchase: ${error.message}`[39m)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 96 |[39m     }
     [90m 97 |[39m }
     [90m 98 |[39m[0m

      at postPurchase (services/autoPostingService.js:95:15)
      at Object.<anonymous> (tests/integration/autoPosting.test.js:174:32)

  ΓùÅ Auto-Posting Service Integration Tests ΓÇ║ Purchase Auto-Posting ΓÇ║ should create journal entry for credit 
purchase

    Failed to post purchase: Required accounts not found

    [0m [90m 93 |[39m
     [90m 94 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 95 |[39m         [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to post 
purchase: ${error.message}`[39m)[33m;[39m
     [90m    |[39m               [31m[1m^[22m[39m
     [90m 96 |[39m     }
     [90m 97 |[39m }
     [90m 98 |[39m[0m

      at postPurchase (services/autoPostingService.js:95:15)
      at Object.<anonymous> (tests/integration/autoPosting.test.js:240:17)

  ΓùÅ Auto-Posting Service Integration Tests ΓÇ║ Sale Auto-Posting ΓÇ║ should create revenue and COGS journal entries

    Failed to post sale: Required accounts not found

    [0m [90m 239 |[39m
     [90m 240 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 241 |[39m         [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to post 
sale: ${error.message}`[39m)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 242 |[39m     }
     [90m 243 |[39m }
     [90m 244 |[39m[0m

      at postSale (services/autoPostingService.js:241:15)
      at Object.<anonymous> (tests/integration/autoPosting.test.js:369:17)

  ΓùÅ Auto-Posting Service Integration Tests ΓÇ║ Sale Auto-Posting ΓÇ║ should handle credit sales correctly

    Failed to post sale: Required accounts not found

    [0m [90m 239 |[39m
     [90m 240 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 241 |[39m         [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to post 
sale: ${error.message}`[39m)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 242 |[39m     }
     [90m 243 |[39m }
     [90m 244 |[39m[0m

      at postSale (services/autoPostingService.js:241:15)
      at Object.<anonymous> (tests/integration/autoPosting.test.js:423:17)

  ΓùÅ Auto-Posting Service Integration Tests ΓÇ║ Payment Auto-Posting ΓÇ║ should create journal entry for payment

    Failed to post payment: Cash/Bank account not found

    [0m [90m 337 |[39m
     [90m 338 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 339 |[39m         [36mthrow[39m [36mnew[39m [33mError[39m([32m`Failed to post 
payment: ${error.message}`[39m)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 340 |[39m     }
     [90m 341 |[39m }
     [90m 342 |[39m[0m

      at postPayment (services/autoPostingService.js:339:15)
      at Object.<anonymous> (tests/integration/autoPosting.test.js:472:17)

  ΓùÅ Auto-Posting Service Integration Tests ΓÇ║ Transaction Safety ΓÇ║ should rollback on error

    ValidationError: ChartOfAccounts validation failed: normalBalance: Path `normalBalance` is required., accountType: 
Path `accountType` is required.

      at model.Object.<anonymous>.Document.invalidate (node_modules/mongoose/lib/document.js:3373:32)
      at node_modules/mongoose/lib/document.js:3134:17
      at node_modules/mongoose/lib/schemaType.js:1446:9

  console.log
    [dotenv@17.2.3] injecting env (12) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    ΓÜá∩╕Å  Sentry not configured (SENTRY_DSN not set)

      at initSentry (config/sentry.js:13:17)

(node:19080) [MONGOOSE] Warning: Duplicate schema index on {"subdomain":1} found. This is often due to declaring an 
index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:19080) [MONGOOSE] Warning: Duplicate schema index on {"entryNumber":1} found. This is often due to declaring an 
index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:19080) [MONGOOSE] Warning: Duplicate schema index on {"code":1} found. This is often due to declaring an index 
using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:19080) [MONGODB DRIVER] Warning: useNewUrlParser is a deprecated option: useNewUrlParser has no effect since 
Node.js Driver version 4.0.0 and will be removed in the next major version
(node:19080) [MONGODB DRIVER] Warning: useUnifiedTopology is a deprecated option: useUnifiedTopology has no effect 
since Node.js Driver version 4.0.0 and will be removed in the next major version
2026-02-01 21:25:17 [[32minfo[39m]: ≡ƒì¬ Set deviceId cookie {"service":"bizzai-backend","deviceId":"732a66a4...","sameSite":"strict","secure":false}
  console.log
    Γ£à Login successful - rate limit counters reset {
      ip: '::ffff:127.0.0.1',
      accountHash: '973dfe463ec85785',
      correlationId: 'unknown'
    }

      at handleLoginAttempt (middlewares/rateLimiter.js:332:17)

::ffff:127.0.0.1 - - [01/Feb/2026:15:55:17 +0000] "POST /api/auth/login HTTP/1.1" 200 573 "-" "-"
2026-02-01 21:25:17 [[32minfo[39m]: Item added by Test User: New Test Item {"service":"bizzai-backend"}
::ffff:127.0.0.1 - - [01/Feb/2026:15:55:17 +0000] "POST /api/inventory HTTP/1.1" 201 573 "-" "-"
2026-02-01 21:25:17 [[32minfo[39m]: ≡ƒì¬ Set deviceId cookie {"service":"bizzai-backend","deviceId":"bf730c23...","sameSite":"strict","secure":false}
  console.log
    Γ£à Login successful - rate limit counters reset {
      ip: '::ffff:127.0.0.1',
      accountHash: '973dfe463ec85785',
      correlationId: 'unknown'
    }

      at handleLoginAttempt (middlewares/rateLimiter.js:332:17)

::ffff:127.0.0.1 - - [01/Feb/2026:15:55:17 +0000] "POST /api/auth/login HTTP/1.1" 200 573 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:55:17 +0000] "POST /api/inventory HTTP/1.1" 400 67 "-" "-"
2026-02-01 21:25:18 [[32minfo[39m]: ≡ƒì¬ Set deviceId cookie {"service":"bizzai-backend","deviceId":"7b7d9b79...","sameSite":"strict","secure":false}
  console.log
    Γ£à Login successful - rate limit counters reset {
      ip: '::ffff:127.0.0.1',
      accountHash: '973dfe463ec85785',
      correlationId: 'unknown'
    }

      at handleLoginAttempt (middlewares/rateLimiter.js:332:17)

::ffff:127.0.0.1 - - [01/Feb/2026:15:55:18 +0000] "POST /api/auth/login HTTP/1.1" 200 573 "-" "-"
2026-02-01 21:25:18 [[32minfo[39m]: Item added by Test User: Stock Test Item {"service":"bizzai-backend"}
::ffff:127.0.0.1 - - [01/Feb/2026:15:55:18 +0000] "POST /api/inventory HTTP/1.1" 201 508 "-" "-"
2026-02-01 21:25:18 [[32minfo[39m]: ≡ƒì¬ Set deviceId cookie {"service":"bizzai-backend","deviceId":"9d846ad7...","sameSite":"strict","secure":false}
  console.log
    Γ£à Login successful - rate limit counters reset {
      ip: '::ffff:127.0.0.1',
      accountHash: '973dfe463ec85785',
      correlationId: 'unknown'
    }

      at handleLoginAttempt (middlewares/rateLimiter.js:332:17)

::ffff:127.0.0.1 - - [01/Feb/2026:15:55:18 +0000] "POST /api/auth/login HTTP/1.1" 200 573 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:55:18 +0000] "GET /api/inventory HTTP/1.1" 200 - "-" "-"
2026-02-01 21:25:19 [[32minfo[39m]: ≡ƒì¬ Set deviceId cookie {"service":"bizzai-backend","deviceId":"bf0d6db2...","sameSite":"strict","secure":false}
  console.log
    Γ£à Login successful - rate limit counters reset {
      ip: '::ffff:127.0.0.1',
      accountHash: '973dfe463ec85785',
      correlationId: 'unknown'
    }

      at handleLoginAttempt (middlewares/rateLimiter.js:332:17)

::ffff:127.0.0.1 - - [01/Feb/2026:15:55:19 +0000] "POST /api/auth/login HTTP/1.1" 200 573 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:55:19 +0000] "GET /api/inventory?category=Category%20A HTTP/1.1" 200 - "-" "-"
2026-02-01 21:25:19 [[32minfo[39m]: ≡ƒì¬ Set deviceId cookie {"service":"bizzai-backend","deviceId":"1a7dd2ae...","sameSite":"strict","secure":false}
  console.log
    Γ£à Login successful - rate limit counters reset {
      ip: '::ffff:127.0.0.1',
      accountHash: '973dfe463ec85785',
      correlationId: 'unknown'
    }

      at handleLoginAttempt (middlewares/rateLimiter.js:332:17)

::ffff:127.0.0.1 - - [01/Feb/2026:15:55:19 +0000] "POST /api/auth/login HTTP/1.1" 200 573 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:55:19 +0000] "GET /api/inventory?search=Item%202 HTTP/1.1" 200 559 "-" "-"
2026-02-01 21:25:19 [[32minfo[39m]: ≡ƒì¬ Set deviceId cookie {"service":"bizzai-backend","deviceId":"81690ea5...","sameSite":"strict","secure":false}
  console.log
    Γ£à Login successful - rate limit counters reset {
      ip: '::ffff:127.0.0.1',
      accountHash: '973dfe463ec85785',
      correlationId: 'unknown'
    }

      at handleLoginAttempt (middlewares/rateLimiter.js:332:17)

::ffff:127.0.0.1 - - [01/Feb/2026:15:55:19 +0000] "POST /api/auth/login HTTP/1.1" 200 573 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:55:20 +0000] "GET /api/inventory HTTP/1.1" 200 - "-" "-"
2026-02-01 21:25:20 [[32minfo[39m]: ≡ƒì¬ Set deviceId cookie {"service":"bizzai-backend","deviceId":"475cef24...","sameSite":"strict","secure":false}
  console.log
    Γ£à Login successful - rate limit counters reset {
      ip: '::ffff:127.0.0.1',
      accountHash: '973dfe463ec85785',
      correlationId: 'unknown'
    }

      at handleLoginAttempt (middlewares/rateLimiter.js:332:17)

::ffff:127.0.0.1 - - [01/Feb/2026:15:55:20 +0000] "POST /api/auth/login HTTP/1.1" 200 573 "-" "-"
2026-02-01 21:25:20 [[32minfo[39m]: Item updated by Test User: Test Item {"service":"bizzai-backend"}
::ffff:127.0.0.1 - - [01/Feb/2026:15:55:20 +0000] "PUT /api/inventory/697f77684470e339ef091b32 HTTP/1.1" 200 574 "-" "-"
2026-02-01 21:25:20 [[31merror[39m]: Audit log failed: AuditLog validation failed: currentHash: Path `currentHash` is required. {"service":"bizzai-backend","errors":{"currentHash":{"name":"ValidatorError","message":"Path `currentHash` is required.","properties":{"message":"Path `currentHash` is required.","type":"required","path":"currentHash"},"kind":"required","path":"currentHash"}},"_message":"AuditLog validation failed","stack":"ValidationError: AuditLog validation failed: currentHash: Path `currentHash` is required.\n    at model.Object.<anonymous>.Document.invalidate (F:\\Inventory Management\\Tushar's Code\\BizzAI\\backend\\node_modules\\mongoose\\lib\\document.js:3373:32)\n    at F:\\Inventory Management\\Tushar's Code\\BizzAI\\backend\\node_modules\\mongoose\\lib\\document.js:3134:17\n    at F:\\Inventory Management\\Tushar's Code\\BizzAI\\backend\\node_modules\\mongoose\\lib\\schemaType.js:1446:9\n    at processTicksAndRejections (node:internal/process/task_queues:77:11)"}
2026-02-01 21:25:20 [[32minfo[39m]: ≡ƒì¬ Set deviceId cookie {"service":"bizzai-backend","deviceId":"59912d21...","sameSite":"strict","secure":false}
  console.log
    Γ£à Login successful - rate limit counters reset {
      ip: '::ffff:127.0.0.1',
      accountHash: '973dfe463ec85785',
      correlationId: 'unknown'
    }

      at handleLoginAttempt (middlewares/rateLimiter.js:332:17)

::ffff:127.0.0.1 - - [01/Feb/2026:15:55:20 +0000] "POST /api/auth/login HTTP/1.1" 200 573 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:55:20 +0000] "PUT /api/inventory/697f77684470e339ef091b7a HTTP/1.1" 404 60 "-" "-"
2026-02-01 21:25:21 [[32minfo[39m]: ≡ƒì¬ Set deviceId cookie {"service":"bizzai-backend","deviceId":"a7eb1906...","sameSite":"strict","secure":false}
  console.log
    Γ£à Login successful - rate limit counters reset {
      ip: '::ffff:127.0.0.1',
      accountHash: '973dfe463ec85785',
      correlationId: 'unknown'
    }

      at handleLoginAttempt (middlewares/rateLimiter.js:332:17)

::ffff:127.0.0.1 - - [01/Feb/2026:15:55:21 +0000] "POST /api/auth/login HTTP/1.1" 200 573 "-" "-"
2026-02-01 21:25:21 [[32minfo[39m]: Item deleted by Test User: Test Item {"service":"bizzai-backend"}
::ffff:127.0.0.1 - - [01/Feb/2026:15:55:21 +0000] "DELETE /api/inventory/697f77694470e339ef091bb7 HTTP/1.1" 200 41 "-" "-"
2026-02-01 21:25:21 [[31merror[39m]: Audit log failed: AuditLog validation failed: currentHash: Path `currentHash` is required. {"service":"bizzai-backend","errors":{"currentHash":{"name":"ValidatorError","message":"Path `currentHash` is required.","properties":{"message":"Path `currentHash` is required.","type":"required","path":"currentHash"},"kind":"required","path":"currentHash"}},"_message":"AuditLog validation failed","stack":"ValidationError: AuditLog validation failed: currentHash: Path `currentHash` is required.\n    at model.Object.<anonymous>.Document.invalidate (F:\\Inventory Management\\Tushar's Code\\BizzAI\\backend\\node_modules\\mongoose\\lib\\document.js:3373:32)\n    at F:\\Inventory Management\\Tushar's Code\\BizzAI\\backend\\node_modules\\mongoose\\lib\\document.js:3134:17\n    at F:\\Inventory Management\\Tushar's Code\\BizzAI\\backend\\node_modules\\mongoose\\lib\\schemaType.js:1446:9\n    at processTicksAndRejections (node:internal/process/task_queues:77:11)"}
2026-02-01 21:25:21 [[32minfo[39m]: ≡ƒì¬ Set deviceId cookie {"service":"bizzai-backend","deviceId":"17b22727...","sameSite":"strict","secure":false}
  console.log
    Γ£à Login successful - rate limit counters reset {
      ip: '::ffff:127.0.0.1',
      accountHash: '973dfe463ec85785',
      correlationId: 'unknown'
    }

      at handleLoginAttempt (middlewares/rateLimiter.js:332:17)

::ffff:127.0.0.1 - - [01/Feb/2026:15:55:21 +0000] "POST /api/auth/login HTTP/1.1" 200 573 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:55:21 +0000] "DELETE /api/inventory/697f77694470e339ef091bfe HTTP/1.1" 404 60 "-" "-"
2026-02-01 21:25:21 [[32minfo[39m]: ≡ƒì¬ Set deviceId cookie {"service":"bizzai-backend","deviceId":"23b86305...","sameSite":"strict","secure":false}
  console.log
    Γ£à Login successful - rate limit counters reset {
      ip: '::ffff:127.0.0.1',
      accountHash: '973dfe463ec85785',
      correlationId: 'unknown'
    }

      at handleLoginAttempt (middlewares/rateLimiter.js:332:17)

::ffff:127.0.0.1 - - [01/Feb/2026:15:55:21 +0000] "POST /api/auth/login HTTP/1.1" 200 573 "-" "-"
::ffff:127.0.0.1 - - [01/Feb/2026:15:55:21 +0000] "GET /api/inventory/low-stock HTTP/1.1" 200 566 "-" "-"
PASS tests/integration/inventory.test.js (9.347 s)
  Inventory API Integration Tests
    POST /api/inventory
      ΓêÜ should create new item successfully (1450 ms)
      ΓêÜ should fail with duplicate item name for same user (469 ms)
      ΓêÜ should calculate available stock correctly (678 ms)
    GET /api/inventory
      ΓêÜ should get all items for authenticated user (367 ms)
      ΓêÜ should filter items by category (302 ms)
      ΓêÜ should search items by name (303 ms)
      ΓêÜ should not return items from other users (453 ms)
    PUT /api/inventory/:id
      ΓêÜ should update item successfully (307 ms)
      ΓêÜ should not allow updating another user's item (398 ms)
    DELETE /api/inventory/:id
      ΓêÜ should delete item successfully (286 ms)
      ΓêÜ should not allow deleting another user's item (375 ms)
    GET /api/inventory/low-stock
      ΓêÜ should return only low stock items (271 ms)

(node:19080) [MONGOOSE] Warning: Duplicate schema index on {"subdomain":1} found. This is often due to declaring an 
index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
(node:19080) [MONGODB DRIVER] Warning: useNewUrlParser is a deprecated option: useNewUrlParser has no effect since 
Node.js Driver version 4.0.0 and will be removed in the next major version
(node:19080) [MONGODB DRIVER] Warning: useUnifiedTopology is a deprecated option: useUnifiedTopology has no effect 
since Node.js Driver version 4.0.0 and will be removed in the next major version
2026-02-01 21:25:24 [[32minfo[39m]: Stock movement logged: RESERVE | Item: Test Item | Qty: 10 | Source: SalesOrder:507f1f77bcf86cd799439011 {"service":"bizzai-backend"}
2026-02-01 21:25:24 [[32minfo[39m]: Stock movement logged: RESERVE | Item: Test Item | Qty: 50 | Source: SalesOrder:507f1f77bcf86cd799439011 {"service":"bizzai-backend"}
2026-02-01 21:25:25 [[32minfo[39m]: Stock movement logged: RESERVE | Item: Test Item | Qty: 30 | Source: SalesOrder:507f1f77bcf86cd799439011 {"service":"bizzai-backend"}
2026-02-01 21:25:25 [[32minfo[39m]: Stock movement logged: RELEASE | Item: Test Item | Qty: -30 | Source: SalesOrder:507f1f77bcf86cd799439011 {"service":"bizzai-backend"}
2026-02-01 21:25:25 [[32minfo[39m]: Stock movement logged: RESERVE | Item: Test Item | Qty: 30 | Source: SalesOrder:507f1f77bcf86cd799439011 {"service":"bizzai-backend"}
2026-02-01 21:25:25 [[32minfo[39m]: Stock movement logged: RESERVE | Item: Test Item | Qty: 20 | Source: SalesOrder:507f1f77bcf86cd799439011 {"service":"bizzai-backend"}
2026-02-01 21:25:25 [[32minfo[39m]: Stock movement logged: DELIVER | Item: Test Item | Qty: -20 | Source: DeliveryChallan:507f1f77bcf86cd799439011 {"service":"bizzai-backend"}
2026-02-01 21:25:25 [[32minfo[39m]: Stock movement logged: RESERVE | Item: Test Item | Qty: 20 | Source: SalesOrder:507f1f77bcf86cd799439011 {"service":"bizzai-backend"}
2026-02-01 21:25:25 [[32minfo[39m]: Stock movement logged: DELIVER | Item: Test Item | Qty: -20 | Source: DeliveryChallan:507f1f77bcf86cd799439011 {"service":"bizzai-backend"}
PASS tests/unit/utils/stockReservation.test.js
  Stock Reservation Utilities
    reserveStock
      ΓêÜ should reserve stock successfully (483 ms)
      ΓêÜ should fail when insufficient stock available (159 ms)
      ΓêÜ should handle partial reservation correctly (162 ms)
      ΓêÜ should prevent negative reservation (133 ms)
    releaseStock
      ΓêÜ should release reserved stock successfully (176 ms)
      ΓêÜ should fail when releasing more than reserved (136 ms)
    deliverStock
      ΓêÜ should deliver stock successfully (163 ms)
      ΓêÜ should handle over-committed stock gracefully (155 ms)

(node:19080) [MONGODB DRIVER] Warning: useNewUrlParser is a deprecated option: useNewUrlParser has no effect since 
Node.js Driver version 4.0.0 and will be removed in the next major version
(node:19080) [MONGODB DRIVER] Warning: useUnifiedTopology is a deprecated option: useUnifiedTopology has no effect 
since Node.js Driver version 4.0.0 and will be removed in the next major version
PASS tests/unit/utils/gstCalculator.test.js
  GST Calculator Utilities
    calculateGST
      ΓêÜ should calculate GST correctly for intrastate transaction (3 ms)
      ΓêÜ should calculate GST correctly for interstate transaction (1 ms)
      ΓêÜ should handle zero tax rate (1 ms)
      ΓêÜ should handle decimal amounts correctly (1 ms)
      ΓêÜ should apply discount before calculating GST (2 ms)
    calculateItemTotal
      ΓêÜ should calculate item total with GST (2 ms)
      ΓêÜ should handle item-level discount (1 ms)
    calculateBillTotal
      ΓêÜ should calculate bill total with multiple items (2 ms)
      ΓêÜ should apply bill-level discount (1 ms)
      ΓêÜ should add shipping charges (1 ms)

Test Suites: 7 failed, 3 passed, 10 total
Tests:       58 failed, 46 passed, 104 total
Snapshots:   0 total
Time:        54.463 s, estimated 72 s
Ran all test suites.
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after 
all tests finished?
